<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>pyec.util.partitions &mdash; PyEC 0.3.0 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0.3.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="PyEC 0.3.0 documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">PyEC 0.3.0 documentation</a> &raquo;</li>
          <li><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for pyec.util.partitions</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Copyright (C) 2012 Alan J Lockett</span>

<span class="sd">Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the &quot;Software&quot;), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:</span>

<span class="sd">The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.</span>

<span class="sd">THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">copy</span> <span class="kn">as</span> <span class="nn">scopy</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">scipy.special</span> <span class="kn">import</span> <span class="n">erf</span>
<span class="kn">from</span> <span class="nn">pyec.config</span> <span class="kn">import</span> <span class="n">Config</span>
<span class="kn">from</span> <span class="nn">pyec.space</span> <span class="kn">import</span> <span class="n">Hyperrectangle</span><span class="p">,</span> <span class="n">BinaryRectangle</span><span class="p">,</span> <span class="n">Complement</span><span class="p">,</span> <span class="n">LayeredSpace</span>
<span class="kn">from</span> <span class="nn">pyec.util.TernaryString</span> <span class="kn">import</span> <span class="n">TernaryString</span>

<span class="kn">import</span> <span class="nn">traceback</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="n">logg</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__file__</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">SeparationException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
   <span class="k">pass</span>


<span class="k">class</span> <span class="nc">AreaException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
   <span class="k">pass</span>


<span class="k">class</span> <span class="nc">Segment</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

   <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">taylorCenter</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">taylorCenter</span> <span class="ow">or</span> <span class="mf">1.0</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">taylorDepth</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">taylorDepth</span> <span class="ow">or</span> <span class="mi">0</span>
      
      <span class="bp">self</span><span class="o">.</span><span class="n">points</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">partitionTree</span> <span class="o">=</span> <span class="n">Partition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">config</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">scoreTree</span> <span class="o">=</span> <span class="n">ScoreTree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">config</span><span class="p">)</span>
      
   <span class="k">def</span> <span class="nf">clearSegment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">points</span>
      <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">partitionTree</span>
      <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">scoreTree</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">points</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">partitionTree</span> <span class="o">=</span> <span class="n">Partition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">scoreTree</span> <span class="o">=</span> <span class="n">ScoreTree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Point</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
   
   <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">segment</span><span class="p">,</span> <span class="n">point</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">statistics</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                <span class="n">score</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">alive</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">segment</span> <span class="o">=</span> <span class="n">segment</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">point</span> <span class="o">=</span> <span class="n">point</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">statistics</span> <span class="o">=</span> <span class="n">statistics</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">score</span> <span class="o">=</span> <span class="n">score</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">alive</span> <span class="o">=</span> <span class="n">alive</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">score_node</span> <span class="o">=</span> <span class="bp">None</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">count</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">partition_node</span> <span class="o">=</span> <span class="bp">None</span>
    
   <span class="nd">@property</span>
   <span class="k">def</span> <span class="nf">id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="k">return</span> <span class="bp">self</span>   
      
   <span class="k">def</span> <span class="nf">separable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">         Get a representation of the point suitable for insertion in the Partition tree.</span>
<span class="sd">         </span>
<span class="sd">         Called by PartitionTree.separate()</span>
<span class="sd">         </span>
<span class="sd">         DEPRECATED, will be removed.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">point</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span> 
         <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">point</span>
      <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">bayes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
         <span class="n">rep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bayes</span><span class="o">.</span><span class="n">edgeBinary</span><span class="p">()</span>
         <span class="k">return</span> <span class="n">rep</span>
      <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">binary</span><span class="p">:</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">segment</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">binaryPartition</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">binary</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">binary</span><span class="o">.</span><span class="n">toArray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">segment</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">dim</span><span class="p">)</span>
      <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">other</span><span class="p">:</span>
         <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">behavioralPartition</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">statistics</span><span class="p">)</span>
         <span class="n">topology</span><span class="p">,</span> <span class="n">angles</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">other</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;::&quot;</span><span class="p">)</span>
         <span class="n">rnn</span> <span class="o">=</span> <span class="n">cpp</span><span class="o">.</span><span class="n">createFromTopology</span><span class="p">(</span><span class="n">topology</span><span class="p">)</span>
         <span class="n">rnn</span> <span class="o">=</span> <span class="n">cpp</span><span class="o">.</span><span class="n">setBinaryAnglesAtDepth</span><span class="p">(</span><span class="n">rnn</span><span class="p">,</span> <span class="n">RnnAngles</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">angles</span><span class="p">)</span><span class="o">.</span><span class="n">toCpp</span><span class="p">(),</span><span class="mi">16</span><span class="p">)</span>
         <span class="c">#rnn = cpp.convert(str(self.other))</span>
         <span class="n">weights</span> <span class="o">=</span> <span class="n">cpp</span><span class="o">.</span><span class="n">getAngles</span><span class="p">(</span><span class="n">rnn</span><span class="p">)</span>
         <span class="n">cpp</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">rnn</span><span class="p">)</span>
         <span class="k">del</span> <span class="n">rnn</span>
         <span class="k">return</span> <span class="n">weights</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="k">return</span> <span class="bp">None</span>

   <span class="nd">@classmethod</span>
   <span class="k">def</span> <span class="nf">bulkSave</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">segment</span><span class="p">,</span> <span class="n">points</span><span class="p">,</span> <span class="n">stats</span><span class="p">):</span>
      <span class="n">segment</span><span class="o">.</span><span class="n">points</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
      
      <span class="n">sep</span> <span class="o">=</span> <span class="n">segment</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">separator</span><span class="p">(</span><span class="n">segment</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
      <span class="k">for</span> <span class="n">gp</span> <span class="ow">in</span> <span class="n">points</span><span class="p">:</span>
         <span class="k">if</span> <span class="n">gp</span><span class="o">.</span><span class="n">score</span> <span class="o">!=</span> <span class="n">gp</span><span class="o">.</span><span class="n">score</span><span class="p">:</span>
            <span class="c"># don&#39;t insert NaN</span>
            <span class="k">continue</span>
         <span class="k">try</span><span class="p">:</span>
            <span class="n">stats</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="s">&quot;separate&quot;</span><span class="p">)</span>
            <span class="n">sep</span><span class="o">.</span><span class="n">separate</span><span class="p">(</span><span class="n">segment</span><span class="o">.</span><span class="n">partitionTree</span><span class="p">,</span> <span class="n">gp</span><span class="p">)</span>
            <span class="n">stats</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="s">&quot;separate&quot;</span><span class="p">)</span>
            <span class="n">stats</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="s">&quot;insert&quot;</span><span class="p">)</span>
            <span class="n">segment</span><span class="o">.</span><span class="n">scoreTree</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">gp</span><span class="p">,</span> <span class="n">segment</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">stats</span><span class="p">)</span>
            <span class="c">#segment.scoreTree.checkBalance()</span>
            <span class="n">stats</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="s">&quot;insert&quot;</span><span class="p">)</span>
         <span class="k">except</span> <span class="n">SeparationException</span><span class="p">:</span>
            <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Exception when separating or inserting points&quot;</span><span class="p">)</span>
            <span class="n">gp</span><span class="o">.</span><span class="n">alive</span> <span class="o">=</span> <span class="bp">False</span>
         <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="n">segment</span><span class="o">.</span><span class="n">scoreTree</span><span class="o">.</span><span class="n">printTree</span><span class="p">(</span><span class="n">segment</span><span class="p">)</span>
            
      <span class="c">#segment.scoreTree.printTree(segment)</span>

   <span class="nd">@classmethod</span>
   <span class="k">def</span> <span class="nf">sampleTournament</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">segment</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">         Sample evolutionary annealing in tournament mode by walking the (balanced) score tree</span>
<span class="sd">      </span>
<span class="sd">         segment - the segment to sample </span>
<span class="sd">         temp - the temperature at which to sample</span>
<span class="sd">         config - a evo.config.Config object containing parameters &quot;pressure&quot; and &quot;learningRate&quot;</span>
<span class="sd">         </span>
<span class="sd">         if config.shiftToDb is True, this will attempt to call sampleTournamentInDb.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">current</span> <span class="o">=</span> <span class="n">segment</span><span class="o">.</span><span class="n">scoreTree</span><span class="o">.</span><span class="n">root</span>
      <span class="nb">min</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">minimize</span><span class="p">)</span>
      
      <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
         <span class="n">children</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">current</span><span class="o">.</span><span class="n">children</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">left</span><span class="p">)</span>
      
         <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">children</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">break</span>
         
         <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">children</span><span class="p">[</span><span class="nb">min</span><span class="p">]</span><span class="o">.</span><span class="n">max_score</span> <span class="o">==</span> <span class="n">children</span><span class="p">[</span><span class="mi">1</span><span class="o">-</span><span class="nb">min</span><span class="p">]</span><span class="o">.</span><span class="n">min_score</span><span class="p">:</span>
               <span class="n">p</span> <span class="o">=</span> <span class="o">.</span><span class="mi">5</span>
            <span class="k">else</span><span class="p">:</span>
               <span class="n">p</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="p">((</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">config</span><span class="o">.</span><span class="n">pressure</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">learningRate</span> <span class="o">/</span> <span class="n">temp</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">height</span><span class="p">))))</span>
         <span class="k">except</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="mf">1.0</span>
         
         <span class="k">if</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">p</span><span class="p">))</span>
            <span class="n">p</span> <span class="o">*=</span> <span class="n">children</span><span class="p">[</span><span class="nb">min</span><span class="p">]</span><span class="o">.</span><span class="n">area</span>
            <span class="n">div</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="n">children</span><span class="p">[</span><span class="mi">1</span><span class="o">-</span><span class="nb">min</span><span class="p">]</span><span class="o">.</span><span class="n">area</span>
            <span class="k">if</span> <span class="n">div</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
               <span class="n">p</span> <span class="o">/=</span> <span class="n">div</span>
            <span class="k">else</span><span class="p">:</span>
               <span class="n">p</span> <span class="o">=</span> <span class="mf">0.5</span>
         
         <span class="n">rnd</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">random_sample</span><span class="p">()</span>
         <span class="k">if</span> <span class="n">rnd</span> <span class="o">&lt;</span> <span class="n">p</span><span class="p">:</span>
            <span class="n">current</span> <span class="o">=</span> <span class="n">children</span><span class="p">[</span><span class="nb">min</span><span class="p">]</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="n">current</span> <span class="o">=</span> <span class="n">children</span><span class="p">[</span><span class="mi">1</span><span class="o">-</span><span class="nb">min</span><span class="p">]</span>
         
      <span class="k">return</span> <span class="n">current</span><span class="o">.</span><span class="n">point</span><span class="p">,</span> <span class="n">current</span><span class="o">.</span><span class="n">point</span><span class="o">.</span><span class="n">partition_node</span>

   <span class="nd">@classmethod</span>
   <span class="k">def</span> <span class="nf">sampleProportional</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">segment</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">         Sample evolutionary annealing in proportional mode by walking the (balanced) score tree.</span>
<span class="sd">      </span>
<span class="sd">         segment - the segment to sample </span>
<span class="sd">         temp - the temperature at which to sample</span>
<span class="sd">         config - a evo.config.Config object containing parameters &quot;pressure&quot; and &quot;learningRate&quot;</span>
<span class="sd">         </span>
<span class="sd">         if config.shiftToDb is True, this will attempt to use a stored procedure for postgres.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="c"># choose the proper center</span>
      <span class="c"># this function has better approximates to the right of the center</span>
      <span class="n">center</span> <span class="o">=</span> <span class="n">segment</span><span class="o">.</span><span class="n">taylorCenter</span>
      <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="n">depth</span> <span class="o">=</span> <span class="n">segment</span><span class="o">.</span><span class="n">taylorDepth</span>
      
      <span class="n">current</span> <span class="o">=</span> <span class="n">segment</span><span class="o">.</span><span class="n">scoreTree</span><span class="o">.</span><span class="n">root</span>
      
      <span class="n">children</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">current</span><span class="o">.</span><span class="n">children</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">left</span><span class="p">)</span>
      <span class="n">ns</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">i</span><span class="o">+</span><span class="mf">0.</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">depth</span><span class="p">)])</span>
      <span class="n">diffs</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="n">temp</span> <span class="o">-</span> <span class="mf">1.</span><span class="o">/</span><span class="n">center</span><span class="p">)</span> <span class="o">**</span> <span class="n">ns</span>
      <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">children</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
         <span class="c"># build choice</span>
         <span class="n">p1</span> <span class="o">=</span> <span class="p">(</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">taylor</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">offset</span><span class="o">+</span><span class="n">depth</span><span class="p">]</span> <span class="o">*</span> <span class="n">diffs</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
         <span class="n">p2</span> <span class="o">=</span> <span class="p">(</span><span class="n">children</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">taylor</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">offset</span><span class="o">+</span><span class="n">depth</span><span class="p">]</span> <span class="o">*</span> <span class="n">diffs</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
         <span class="k">if</span> <span class="n">p1</span> <span class="o">&gt;</span> <span class="mf">0.0</span> <span class="ow">or</span> <span class="n">p2</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">p1</span> <span class="o">=</span> <span class="n">p1</span> <span class="o">/</span> <span class="p">(</span><span class="n">p1</span> <span class="o">+</span> <span class="n">p2</span><span class="p">)</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="n">p1</span> <span class="o">=</span> <span class="o">.</span><span class="mi">5</span>
         <span class="n">idx</span> <span class="o">=</span> <span class="mi">1</span>
         <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random_sample</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">p1</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
         <span class="n">current</span> <span class="o">=</span> <span class="n">children</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
         <span class="n">children</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">current</span><span class="o">.</span><span class="n">children</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">left</span><span class="p">)</span>
      
      <span class="k">return</span> <span class="n">current</span><span class="o">.</span><span class="n">point</span><span class="p">,</span> <span class="n">current</span><span class="o">.</span><span class="n">point</span><span class="o">.</span><span class="n">partition_node</span>

   <span class="nd">@classmethod</span>
   <span class="k">def</span> <span class="nf">sampleRegionalTournament</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">segment</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">         Sample regions from partition tree using a tournament at each node</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">current</span> <span class="o">=</span> <span class="n">segment</span><span class="o">.</span><span class="n">partitionTree</span><span class="o">.</span><span class="n">root</span>
      <span class="n">currentArea</span> <span class="o">=</span> <span class="n">current</span><span class="o">.</span><span class="n">area</span>
      <span class="n">children</span> <span class="o">=</span> <span class="n">current</span><span class="o">.</span><span class="n">children</span>
      <span class="n">q</span> <span class="o">=</span> <span class="o">.</span><span class="mi">5</span> <span class="o">+</span> <span class="o">.</span><span class="mi">5</span> <span class="o">*</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">pressure</span> <span class="o">**</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="p">(</span><span class="n">temp</span><span class="o">*</span><span class="n">config</span><span class="o">.</span><span class="n">learningRate</span><span class="p">)))</span>
      <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">children</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
         <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">children</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">best_score</span> <span class="o">==</span> <span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">best_score</span><span class="p">:</span>
               <span class="n">p</span> <span class="o">=</span> <span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">area</span> <span class="o">/</span> <span class="p">(</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">area</span> <span class="o">+</span> <span class="n">children</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">area</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
               <span class="k">if</span> <span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">best_score</span> <span class="o">&gt;</span> <span class="n">children</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">best_score</span><span class="p">:</span>
                  <span class="n">p0</span> <span class="o">=</span> <span class="n">q</span> <span class="o">*</span> <span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">area</span>
                  <span class="n">p1</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">q</span><span class="p">)</span> <span class="o">*</span> <span class="n">children</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">area</span>
               <span class="k">else</span><span class="p">:</span> <span class="c">#  children[1].best_score &gt; children[0].best_score:</span>
                  <span class="n">p0</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">q</span><span class="p">)</span> <span class="o">*</span> <span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">area</span>
                  <span class="n">p1</span> <span class="o">=</span> <span class="n">q</span> <span class="o">*</span> <span class="n">children</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">area</span>
               <span class="n">p</span> <span class="o">=</span> <span class="n">p0</span> <span class="o">/</span> <span class="p">(</span><span class="n">p0</span> <span class="o">+</span> <span class="n">p1</span><span class="p">)</span>
         <span class="k">except</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="o">.</span><span class="mi">5</span>
         <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random_sample</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">p</span><span class="p">:</span>
            <span class="n">current</span> <span class="o">=</span> <span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">currentArea</span> <span class="o">=</span> <span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">area</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="n">current</span> <span class="o">=</span> <span class="n">children</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">currentArea</span> <span class="o">=</span> <span class="n">children</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">area</span>
         <span class="n">children</span> <span class="o">=</span> <span class="n">current</span><span class="o">.</span><span class="n">children</span>
      
      <span class="k">return</span> <span class="n">current</span><span class="o">.</span><span class="n">point</span><span class="p">,</span> <span class="n">current</span> 


<div class="viewcode-block" id="SeparationAlgorithm"><a class="viewcode-back" href="../../../index.html#pyec.util.partitions.SeparationAlgorithm">[docs]</a><span class="k">class</span> <span class="nc">SeparationAlgorithm</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
   <span class="sd">&quot;&quot;&quot;A algorithm that enables traversal and separation of the partition tree.</span>
<span class="sd">   This class abstracts the space-dependent portions of the partitioning</span>
<span class="sd">   logic.</span>
<span class="sd">   </span>
<span class="sd">   :param config: Configuration parameters</span>
<span class="sd">   :type config: :class:`Config`</span>
<span class="sd">   </span>
<span class="sd">   &quot;&quot;&quot;</span>
   <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">compatible</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">space</span><span class="p">):</span>
         <span class="n">err</span> <span class="o">=</span> <span class="s">&quot;{0} is not compatible with space {1}&quot;</span>
         <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">space</span><span class="p">))</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
      
<div class="viewcode-block" id="SeparationAlgorithm.compatible"><a class="viewcode-back" href="../../../index.html#pyec.util.partitions.SeparationAlgorithm.compatible">[docs]</a>   <span class="k">def</span> <span class="nf">compatible</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">space</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;Check whether this partitioning method is compatible with a given space</span>
<span class="sd">      </span>
<span class="sd">      :param space: The space to check</span>
<span class="sd">      :type space: class:`Space`</span>
<span class="sd">      </span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">True</span>
   </div>
   <span class="k">def</span> <span class="nf">firstPoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">point</span><span class="p">):</span>
      <span class="n">node</span><span class="o">.</span><span class="n">point</span> <span class="o">=</span> <span class="n">point</span>
      <span class="n">point</span><span class="o">.</span><span class="n">partition_node</span> <span class="o">=</span> <span class="n">node</span>
      <span class="n">tree</span><span class="o">.</span><span class="n">areaTree</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
   
<div class="viewcode-block" id="SeparationAlgorithm.separate"><a class="viewcode-back" href="../../../index.html#pyec.util.partitions.SeparationAlgorithm.separate">[docs]</a>   <span class="k">def</span> <span class="nf">separate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree</span><span class="p">,</span> <span class="n">point</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;Insert the point into the partition tree,</span>
<span class="sd">         separating the current partition that contains it.</span>
<span class="sd">         </span>
<span class="sd">         :param tree: The partition tree</span>
<span class="sd">         :type tree: :class:`Partition`</span>
<span class="sd">         :param point: The point to insert</span>
<span class="sd">         :type point: ``config.space.type``</span>
<span class="sd">         :param config: A :class:`Config` object</span>
<span class="sd">         :type config: :class:`Config`</span>
<span class="sd">         :param stats: - an :class:`RunStats` object</span>
<span class="sd">         :type stats: :class:`RunStats`</span>
<span class="sd">         </span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="s">&quot;separate.traverse&quot;</span><span class="p">)</span>
      <span class="n">lr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">learningRate</span>
      <span class="n">node</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="s">&quot;separate.traverse&quot;</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">point</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">bounds</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">space</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">firstPoint</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">point</span><span class="p">)</span>
         <span class="k">return</span>
      
      <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="s">&quot;separate.main&quot;</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="s">&quot;separate.prepare&quot;</span><span class="p">)</span>
      
      <span class="n">other</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">point</span>
      <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
         
      <span class="c"># update the best score</span>
      <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">minimize</span> <span class="ow">and</span> <span class="p">(</span><span class="n">other</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span>
                                      <span class="n">point</span><span class="o">.</span><span class="n">score</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">score</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>
               <span class="n">n</span><span class="o">.</span><span class="n">best_score</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">point</span><span class="o">.</span><span class="n">score</span><span class="p">,</span><span class="n">n</span><span class="o">.</span><span class="n">best_score</span><span class="p">])</span>
         <span class="k">elif</span> <span class="n">other</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">point</span><span class="o">.</span><span class="n">score</span> <span class="o">&gt;</span> <span class="n">other</span><span class="o">.</span><span class="n">score</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>
               <span class="n">n</span><span class="o">.</span><span class="n">best_score</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">point</span><span class="o">.</span><span class="n">score</span><span class="p">,</span><span class="n">n</span><span class="o">.</span><span class="n">best_score</span><span class="p">])</span>
      
      <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="s">&quot;separate.compute&quot;</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="s">&quot;separate.main&quot;</span><span class="p">)</span>
      
      <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="s">&quot;separate.areaTree&quot;</span><span class="p">)</span>
      
      <span class="k">try</span><span class="p">:</span>
         <span class="k">if</span> <span class="n">n1</span><span class="o">.</span><span class="n">point</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
             <span class="n">tree</span><span class="o">.</span><span class="n">areaTree</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">n1</span><span class="p">)</span>
         <span class="k">if</span> <span class="n">n2</span><span class="o">.</span><span class="n">point</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
             <span class="n">tree</span><span class="o">.</span><span class="n">areaTree</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">n2</span><span class="p">)</span>
         <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">bounds</span><span class="p">,</span> <span class="n">Complement</span><span class="p">):</span>
             <span class="n">tree</span><span class="o">.</span><span class="n">areaTree</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
      <span class="k">except</span> <span class="n">AreaException</span><span class="p">:</span>
         <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
         <span class="k">raise</span>
      
      <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="s">&quot;separate.areaTree&quot;</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="s">&quot;separate.propagate&quot;</span><span class="p">)</span>
      
      <span class="c"># correct area in score tree</span>
      <span class="k">if</span> <span class="n">other</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">other</span><span class="o">.</span><span class="n">score_node</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
         <span class="n">sn</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">score_node</span>
         <span class="n">diff</span> <span class="o">=</span> <span class="n">sn</span><span class="o">.</span><span class="n">area</span> <span class="o">-</span> <span class="n">other</span><span class="o">.</span><span class="n">partition_node</span><span class="o">.</span><span class="n">area</span>
         <span class="n">sn</span><span class="o">.</span><span class="n">segment</span><span class="o">.</span><span class="n">scoreTree</span><span class="o">.</span><span class="n">propagateAreaOnly</span><span class="p">(</span><span class="n">sn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">diff</span><span class="p">)</span>
      
      <span class="c">#print &quot;end separate&quot;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="s">&quot;separate.propagate&quot;</span><span class="p">)</span>
      </div>
<div class="viewcode-block" id="SeparationAlgorithm.split"><a class="viewcode-back" href="../../../index.html#pyec.util.partitions.SeparationAlgorithm.split">[docs]</a>   <span class="k">def</span> <span class="nf">split</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;Do the actual work to partition a region.</span>
<span class="sd">      </span>
<span class="sd">      :param point: The point that resulted in the split</span>
<span class="sd">      :type point: ``config.space.type``</span>
<span class="sd">      :param node: A node from the partition tree corresponding to a region</span>
<span class="sd">                   of the space</span>
<span class="sd">      :type node: :class:`PartitionTreeNode`</span>
<span class="sd">      :throws: :class:`SeparationException` when separation of the node fails</span>
<span class="sd">      </span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&quot;Abstract Separation Algorithm; use a subclass&quot;</span><span class="p">)</span>

</div></div>
<span class="k">class</span> <span class="nc">VectorSeparationAlgorithm</span><span class="p">(</span><span class="n">SeparationAlgorithm</span><span class="p">):</span>
   <span class="k">def</span> <span class="nf">compatible</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">space</span><span class="p">):</span>
      <span class="k">return</span> <span class="n">space</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">ndarray</span>
   
   <span class="k">def</span> <span class="nf">cast</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">point</span><span class="p">):</span>
      <span class="k">return</span> <span class="n">point</span><span class="o">.</span><span class="n">point</span>
   
   <span class="k">def</span> <span class="nf">rectify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pointrep</span><span class="p">,</span> <span class="n">otherrep</span><span class="p">):</span>
      <span class="k">try</span><span class="p">:</span>
         <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pointrep</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">otherrep</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">pointrep</span><span class="p">,</span> <span class="n">otherrep</span>
         
         <span class="n">pointrep</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pointrep</span><span class="p">)</span>
         <span class="n">otherrep</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">otherrep</span><span class="p">)</span>
      
         <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">pointrep</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">otherrep</span><span class="p">):</span>
            <span class="n">pointrep</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
         <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">pointrep</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">otherrep</span><span class="p">):</span>
            <span class="n">otherrep</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            
      <span class="k">except</span><span class="p">:</span>
         <span class="k">pass</span>
      
      <span class="k">return</span> <span class="n">pointrep</span><span class="p">,</span> <span class="n">otherrep</span>
   
   <span class="k">def</span> <span class="nf">chooseIndex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pointrep</span><span class="p">,</span> <span class="n">otherrep</span><span class="p">,</span> <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">):</span>
      <span class="n">newDiff</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="n">newIndex</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pointrep</span><span class="p">)):</span>
         <span class="k">if</span> <span class="n">lower</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">upper</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="k">continue</span>
         <span class="n">diff</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">pointrep</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">otherrep</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
         <span class="k">if</span> <span class="n">diff</span> <span class="o">&gt;</span> <span class="n">newDiff</span><span class="p">:</span>
            <span class="n">newDiff</span> <span class="o">=</span> <span class="n">diff</span>
            <span class="n">newIndex</span> <span class="o">=</span> <span class="n">i</span>
      
      <span class="k">return</span> <span class="n">newIndex</span><span class="p">,</span> <span class="n">newDiff</span>
   
   <span class="k">def</span> <span class="nf">makeParts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">pointrep</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">otherrep</span><span class="p">,</span> <span class="n">newIndex</span><span class="p">,</span> <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">):</span>
      <span class="k">if</span> <span class="n">pointrep</span><span class="p">[</span><span class="n">newIndex</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">otherrep</span><span class="p">[</span><span class="n">newIndex</span><span class="p">]:</span>
         <span class="n">upPoint</span> <span class="o">=</span> <span class="n">point</span>
         <span class="n">downPoint</span> <span class="o">=</span> <span class="n">other</span>
         <span class="n">midPoint</span> <span class="o">=</span> <span class="p">(</span><span class="n">otherrep</span><span class="p">[</span><span class="n">newIndex</span><span class="p">]</span> 
                     <span class="o">+</span> <span class="p">(</span><span class="n">pointrep</span><span class="p">[</span><span class="n">newIndex</span><span class="p">]</span> <span class="o">-</span> <span class="n">otherrep</span><span class="p">[</span><span class="n">newIndex</span><span class="p">])</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="n">upPoint</span> <span class="o">=</span> <span class="n">other</span>
         <span class="n">downPoint</span> <span class="o">=</span> <span class="n">point</span>
         <span class="n">midPoint</span> <span class="o">=</span> <span class="p">(</span><span class="n">pointrep</span><span class="p">[</span><span class="n">newIndex</span><span class="p">]</span> 
                     <span class="o">+</span> <span class="p">(</span><span class="n">otherrep</span><span class="p">[</span><span class="n">newIndex</span><span class="p">]</span> <span class="o">-</span> <span class="n">pointrep</span><span class="p">[</span><span class="n">newIndex</span><span class="p">])</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
      
      <span class="n">downUpper</span> <span class="o">=</span> <span class="n">upper</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
      <span class="n">downLower</span> <span class="o">=</span> <span class="n">lower</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
      <span class="n">downUpper</span><span class="p">[</span><span class="n">newIndex</span><span class="p">]</span> <span class="o">=</span> <span class="n">midPoint</span>
      <span class="n">down</span> <span class="o">=</span> <span class="n">Hyperrectangle</span><span class="p">(</span><span class="n">downLower</span><span class="p">,</span> <span class="n">downUpper</span><span class="p">)</span>
      <span class="n">down</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">partition_node</span><span class="o">.</span><span class="n">bounds</span>
      <span class="n">down</span><span class="o">.</span><span class="n">owner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">space</span>
      
      <span class="n">upUpper</span> <span class="o">=</span> <span class="n">upper</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
      <span class="n">upLower</span> <span class="o">=</span> <span class="n">lower</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
      <span class="n">upLower</span><span class="p">[</span><span class="n">newIndex</span><span class="p">]</span> <span class="o">=</span> <span class="n">midPoint</span>
      <span class="n">up</span> <span class="o">=</span> <span class="n">Hyperrectangle</span><span class="p">(</span><span class="n">upLower</span><span class="p">,</span> <span class="n">upUpper</span><span class="p">)</span>
      <span class="n">up</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">partition_node</span><span class="o">.</span><span class="n">bounds</span>
      <span class="n">up</span><span class="o">.</span><span class="n">owner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">space</span>
      
      <span class="k">return</span> <span class="n">down</span><span class="p">,</span> <span class="n">up</span><span class="p">,</span> <span class="n">downPoint</span><span class="p">,</span> <span class="n">upPoint</span>
   
   <span class="k">def</span> <span class="nf">split</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;A vector-based separation algorithm that generates</span>
<span class="sd">      Hyperrectangular partitions parallel to the axes.</span>
<span class="sd">      </span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">other</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">point</span>
      <span class="n">node</span><span class="o">.</span><span class="n">point</span> <span class="o">=</span> <span class="bp">None</span>
      
      <span class="n">newIndex</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="n">newDiff</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="n">midPoint</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="n">upPoint</span> <span class="o">=</span> <span class="n">other</span>
      <span class="n">downPoint</span> <span class="o">=</span> <span class="n">point</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="s">&quot;separate.prepare&quot;</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="s">&quot;separate.separable&quot;</span><span class="p">)</span>
      <span class="n">pointrep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>
      <span class="n">otherrep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
      <span class="n">pointrep</span><span class="p">,</span> <span class="n">otherrep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rectify</span><span class="p">(</span><span class="n">pointrep</span><span class="p">,</span> <span class="n">otherrep</span><span class="p">)</span>
      <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">extent</span><span class="p">()</span>
      <span class="n">newIndex</span><span class="p">,</span> <span class="n">newDiff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chooseIndex</span><span class="p">(</span><span class="n">pointrep</span><span class="p">,</span> <span class="n">otherrep</span><span class="p">,</span> <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="s">&quot;separate.separable&quot;</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">newDiff</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
         <span class="n">node</span><span class="o">.</span><span class="n">point</span> <span class="o">=</span> <span class="n">other</span>
         <span class="k">raise</span> <span class="n">SeparationException</span><span class="p">(</span><span class="s">&quot;No difference in points&quot;</span><span class="p">)</span>
      
      <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="s">&quot;separate.compute&quot;</span><span class="p">)</span>
      <span class="n">down</span><span class="p">,</span> <span class="n">up</span><span class="p">,</span> <span class="n">downPoint</span><span class="p">,</span> <span class="n">upPoint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">makeParts</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="n">pointrep</span><span class="p">,</span>
                                                    <span class="n">other</span><span class="p">,</span> <span class="n">otherrep</span><span class="p">,</span>
                                                    <span class="n">newIndex</span><span class="p">,</span>
                                                    <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">)</span>
      
      <span class="n">downArea</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">down</span><span class="o">.</span><span class="n">area</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">newIndex</span><span class="p">))</span>      
      <span class="n">upArea</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">up</span><span class="o">.</span><span class="n">area</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">newIndex</span><span class="p">))</span>
      
      <span class="k">if</span> <span class="n">upArea</span> <span class="o">!=</span> <span class="n">upArea</span> <span class="ow">or</span> <span class="n">downArea</span> <span class="o">!=</span> <span class="n">downArea</span><span class="p">:</span>
         <span class="k">raise</span> <span class="n">SeparationException</span><span class="p">(</span><span class="s">&quot;NaN area!&quot;</span><span class="p">)</span>
      
      <span class="n">n1</span> <span class="o">=</span> <span class="n">PartitionTreeNode</span><span class="p">(</span>
         <span class="n">segment</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">segment</span><span class="p">,</span>
         <span class="n">point</span><span class="o">=</span><span class="n">upPoint</span><span class="p">,</span>
         <span class="n">area</span> <span class="o">=</span> <span class="n">upArea</span><span class="p">,</span>
         <span class="n">bounds</span> <span class="o">=</span> <span class="n">up</span><span class="p">,</span>
         <span class="n">index</span> <span class="o">=</span> <span class="n">newIndex</span><span class="p">,</span>
         <span class="n">upper</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
         <span class="n">lower</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
         <span class="n">best_score</span> <span class="o">=</span> <span class="n">upPoint</span><span class="o">.</span><span class="n">score</span><span class="p">,</span>
         <span class="n">score_sum</span> <span class="o">=</span> <span class="n">upPoint</span><span class="o">.</span><span class="n">score</span><span class="p">,</span>
         <span class="n">parent</span> <span class="o">=</span> <span class="n">node</span><span class="p">,</span>
         <span class="n">layer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
         <span class="n">layerrep</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
      <span class="p">)</span>
    
      <span class="n">n2</span> <span class="o">=</span> <span class="n">PartitionTreeNode</span><span class="p">(</span>
         <span class="n">segment</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">segment</span><span class="p">,</span>
         <span class="n">point</span><span class="o">=</span><span class="n">downPoint</span><span class="p">,</span>
         <span class="n">area</span> <span class="o">=</span> <span class="n">downArea</span><span class="p">,</span>
         <span class="n">bounds</span> <span class="o">=</span> <span class="n">down</span><span class="p">,</span>
         <span class="n">index</span> <span class="o">=</span> <span class="n">newIndex</span><span class="p">,</span>
         <span class="n">upper</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
         <span class="n">lower</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
         <span class="n">best_score</span> <span class="o">=</span> <span class="n">downPoint</span><span class="o">.</span><span class="n">score</span><span class="p">,</span>
         <span class="n">score_sum</span> <span class="o">=</span> <span class="n">downPoint</span><span class="o">.</span><span class="n">score</span><span class="p">,</span>
         <span class="n">parent</span> <span class="o">=</span> <span class="n">node</span><span class="p">,</span>
         <span class="n">layer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
         <span class="n">layerrep</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
      <span class="p">)</span>

      <span class="n">node</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="p">[</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">]</span>
      <span class="n">upPoint</span><span class="o">.</span><span class="n">partition_node</span> <span class="o">=</span> <span class="n">n1</span>
      <span class="n">downPoint</span><span class="o">.</span><span class="n">partition_node</span> <span class="o">=</span> <span class="n">n2</span>
      
      <span class="k">return</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span>
 

<div class="viewcode-block" id="LongestSideVectorSeparationAlgorithm"><a class="viewcode-back" href="../../../index.html#pyec.util.partitions.LongestSideVectorSeparationAlgorithm">[docs]</a><span class="k">class</span> <span class="nc">LongestSideVectorSeparationAlgorithm</span><span class="p">(</span><span class="n">VectorSeparationAlgorithm</span><span class="p">):</span>
   <span class="sd">&quot;&quot;&quot;Like :class:`VectorSeparationAlgorithm`, except that it always</span>
<span class="sd">   partitions the longest side. This can be helpful to guarantee that the</span>
<span class="sd">   longest side length of any partition hyperrectangle is reduced</span>
<span class="sd">   evenly.</span>
<span class="sd">   </span>
<span class="sd">   &quot;&quot;&quot;</span>
   <span class="k">def</span> <span class="nf">chooseIndex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pointrep</span><span class="p">,</span> <span class="n">otherrep</span><span class="p">,</span> <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">):</span>
      <span class="n">newIndex</span> <span class="o">=</span> <span class="bp">None</span>
      <span class="n">newDiff</span> <span class="o">=</span> <span class="mf">0.0</span>
      <span class="n">infinity</span> <span class="o">=</span> <span class="bp">False</span>
      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pointrep</span><span class="p">)):</span>
         <span class="k">if</span> <span class="n">pointrep</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">otherrep</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="k">continue</span>
         <span class="k">if</span> <span class="n">upper</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">inf</span> <span class="ow">and</span> <span class="n">lower</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="n">inf</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">i</span><span class="p">,</span> <span class="n">inf</span>
         <span class="k">elif</span> <span class="n">upper</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">inf</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">infinity</span><span class="p">:</span>
               <span class="k">if</span> <span class="o">-</span><span class="n">lower</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">newDiff</span><span class="p">:</span>
                  <span class="n">newDiff</span> <span class="o">=</span> <span class="o">-</span><span class="n">lower</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                  <span class="n">newIndex</span> <span class="o">=</span> <span class="n">i</span>
            <span class="k">else</span><span class="p">:</span>
               <span class="n">infinity</span> <span class="o">=</span> <span class="bp">True</span>
               <span class="n">newDiff</span> <span class="o">=</span> <span class="o">-</span><span class="n">lower</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
               <span class="n">newIndex</span> <span class="o">=</span> <span class="n">i</span>
         <span class="k">elif</span> <span class="n">lower</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="n">inf</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">infinity</span><span class="p">:</span>
               <span class="k">if</span> <span class="n">upper</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">newDiff</span><span class="p">:</span>
                  <span class="n">newDiff</span> <span class="o">=</span> <span class="n">upper</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                  <span class="n">newIndex</span> <span class="o">=</span> <span class="n">i</span>
            <span class="k">else</span><span class="p">:</span>
               <span class="n">infinity</span> <span class="o">=</span> <span class="bp">True</span>
               <span class="n">newDiff</span> <span class="o">=</span> <span class="n">upper</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
               <span class="n">newIndex</span> <span class="o">=</span> <span class="n">i</span>
         <span class="k">elif</span> <span class="ow">not</span> <span class="n">infinity</span><span class="p">:</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="n">upper</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">lower</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">diff</span> <span class="o">&gt;</span> <span class="n">newDiff</span><span class="p">:</span>
               <span class="n">newDiff</span> <span class="o">=</span> <span class="n">diff</span>
               <span class="n">newIndex</span> <span class="o">=</span> <span class="n">i</span>
            
      <span class="k">if</span> <span class="n">infinity</span><span class="p">:</span>
         <span class="k">return</span> <span class="n">newIndex</span><span class="p">,</span> <span class="n">inf</span>
      
      <span class="k">if</span> <span class="n">newIndex</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
         <span class="k">raise</span> <span class="n">SeparationException</span><span class="p">(</span><span class="s">&quot;No difference between points&quot;</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">newIndex</span><span class="p">,</span> <span class="n">newDiff</span>

</div>
<span class="k">class</span> <span class="nc">BinarySeparationAlgorithm</span><span class="p">(</span><span class="n">VectorSeparationAlgorithm</span><span class="p">):</span>
   <span class="k">def</span> <span class="nf">compatible</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">space</span><span class="p">):</span>
      <span class="k">return</span> <span class="n">space</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">TernaryString</span>
   
   <span class="k">def</span> <span class="nf">rectify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pointrep</span><span class="p">,</span> <span class="n">otherrep</span><span class="p">):</span>
      <span class="k">if</span> <span class="n">pointrep</span><span class="o">.</span><span class="n">length</span> <span class="o">&lt;</span> <span class="n">otherrep</span><span class="o">.</span><span class="n">length</span><span class="p">:</span>
         <span class="n">pointrep</span><span class="o">.</span><span class="n">known</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="il">1L</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">pointrep</span><span class="o">.</span><span class="n">length</span><span class="p">))</span> <span class="o">-</span> <span class="il">1L</span>
         <span class="n">pointrep</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">otherrep</span><span class="o">.</span><span class="n">length</span>
      
      <span class="k">if</span> <span class="n">otherrep</span><span class="o">.</span><span class="n">length</span> <span class="o">&lt;</span> <span class="n">pointrep</span><span class="o">.</span><span class="n">length</span><span class="p">:</span>
         <span class="n">otherrep</span><span class="o">.</span><span class="n">known</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="il">1L</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">otherrep</span><span class="o">.</span><span class="n">length</span><span class="p">))</span> <span class="o">-</span> <span class="il">1L</span>
         <span class="n">otherrep</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">pointrep</span><span class="o">.</span><span class="n">length</span>
         
      <span class="k">return</span> <span class="n">pointrep</span><span class="p">,</span> <span class="n">otherrep</span>

   <span class="k">def</span> <span class="nf">chooseIndex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pointrep</span><span class="p">,</span> <span class="n">otherrep</span><span class="p">,</span> <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">):</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">pointrep</span><span class="o">.</span><span class="n">known</span> <span class="o">&amp;</span> <span class="n">pointrep</span><span class="o">.</span><span class="n">base</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">otherrep</span><span class="o">.</span><span class="n">known</span> <span class="o">&amp;</span> <span class="n">otherrep</span><span class="o">.</span><span class="n">base</span><span class="p">):</span>
         <span class="k">raise</span> <span class="n">SeparationException</span><span class="p">(</span><span class="s">&quot;No difference between points&quot;</span><span class="p">)</span>
      
      <span class="n">diff</span> <span class="o">=</span> <span class="n">pointrep</span> <span class="o">^</span> <span class="n">otherrep</span>
      
      <span class="c"># randomly wrap the bits, and then take the first difference</span>
      <span class="n">wrap</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">diff</span><span class="o">.</span><span class="n">length</span><span class="p">)</span>
      <span class="n">maskAll</span> <span class="o">=</span> <span class="p">(</span><span class="il">1L</span> <span class="o">&lt;&lt;</span> <span class="n">diff</span><span class="o">.</span><span class="n">length</span><span class="p">)</span> <span class="o">-</span> <span class="il">1L</span>
      <span class="n">maskLow</span> <span class="o">=</span> <span class="il">1L</span> <span class="o">&lt;&lt;</span> <span class="n">wrap</span>
      <span class="n">wrapHigh</span> <span class="o">=</span> <span class="p">(</span><span class="n">diff</span><span class="o">.</span><span class="n">base</span> <span class="o">&amp;</span> <span class="n">maskAll</span><span class="p">)</span> <span class="o">//</span> <span class="n">maskLow</span>
      <span class="n">wrapKnownH</span> <span class="o">=</span> <span class="p">(</span><span class="n">diff</span><span class="o">.</span><span class="n">known</span> <span class="o">&amp;</span> <span class="n">maskAll</span><span class="p">)</span> <span class="o">//</span> <span class="n">maskLow</span>
      <span class="n">maskLow</span> <span class="o">-=</span> <span class="il">1L</span>
      <span class="n">wrapLow</span> <span class="o">=</span> <span class="n">diff</span><span class="o">.</span><span class="n">base</span> <span class="o">&amp;</span> <span class="n">maskLow</span>
      <span class="n">wrapKnownL</span> <span class="o">=</span> <span class="n">diff</span><span class="o">.</span><span class="n">known</span> <span class="o">&amp;</span> <span class="n">maskLow</span>
      <span class="n">rebuilt</span> <span class="o">=</span> <span class="n">TernaryString</span><span class="p">(</span><span class="n">wrapHigh</span> <span class="o">|</span> <span class="p">(</span><span class="n">wrapLow</span> <span class="o">&lt;&lt;</span> <span class="n">wrap</span><span class="p">),</span>
                              <span class="n">wrapKnownH</span> <span class="o">|</span> <span class="p">(</span><span class="n">wrapKnownL</span> <span class="o">&lt;&lt;</span> <span class="n">wrap</span><span class="p">),</span>
                              <span class="n">diff</span><span class="o">.</span><span class="n">length</span><span class="p">)</span>
      <span class="n">mask</span> <span class="o">=</span> <span class="il">1L</span>
      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">rebuilt</span><span class="o">.</span><span class="n">length</span><span class="p">):</span>
         <span class="k">if</span> <span class="n">rebuilt</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="k">return</span> <span class="p">((</span><span class="n">i</span> <span class="o">+</span> <span class="p">(</span><span class="n">diff</span><span class="o">.</span><span class="n">length</span> <span class="o">-</span> <span class="n">wrap</span><span class="p">))</span> <span class="o">%</span> <span class="n">diff</span><span class="o">.</span><span class="n">length</span><span class="p">),</span> <span class="mf">1.0</span>
      
      <span class="k">raise</span> <span class="n">SeparationException</span><span class="p">(</span><span class="s">&quot;No difference in points&quot;</span><span class="p">)</span>
   
   <span class="k">def</span> <span class="nf">makeParts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">pointrep</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">otherrep</span><span class="p">,</span> <span class="n">newIndex</span><span class="p">,</span> <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">):</span>
      <span class="k">if</span> <span class="n">pointrep</span><span class="p">[</span><span class="n">newIndex</span><span class="p">]:</span>
         <span class="n">upPoint</span> <span class="o">=</span> <span class="n">point</span>
         <span class="n">downPoint</span> <span class="o">=</span> <span class="n">other</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="n">upPoint</span> <span class="o">=</span> <span class="n">other</span>
         <span class="n">downPoint</span> <span class="o">=</span> <span class="n">point</span>
      
      <span class="n">mask</span> <span class="o">=</span> <span class="il">1L</span> <span class="o">&lt;&lt;</span> <span class="n">newIndex</span>
      
      <span class="n">downSpec</span> <span class="o">=</span> <span class="n">TernaryString</span><span class="p">((</span><span class="n">lower</span><span class="o">.</span><span class="n">base</span> <span class="o">&amp;</span> <span class="n">lower</span><span class="o">.</span><span class="n">known</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">,</span>
                               <span class="n">lower</span><span class="o">.</span><span class="n">known</span> <span class="o">|</span> <span class="n">mask</span><span class="p">,</span>
                               <span class="n">lower</span><span class="o">.</span><span class="n">length</span><span class="p">)</span>
      <span class="n">down</span> <span class="o">=</span> <span class="n">BinaryRectangle</span><span class="p">(</span><span class="n">downSpec</span><span class="p">)</span>
      <span class="n">down</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">partition_node</span><span class="o">.</span><span class="n">bounds</span>
      
      <span class="n">upSpec</span> <span class="o">=</span> <span class="n">TernaryString</span><span class="p">((</span><span class="n">upper</span><span class="o">.</span><span class="n">base</span> <span class="o">&amp;</span> <span class="n">upper</span><span class="o">.</span><span class="n">known</span><span class="p">)</span> <span class="o">|</span> <span class="n">mask</span><span class="p">,</span>
                             <span class="n">upper</span><span class="o">.</span><span class="n">known</span> <span class="o">|</span> <span class="n">mask</span><span class="p">,</span>
                             <span class="n">upper</span><span class="o">.</span><span class="n">length</span><span class="p">)</span>
      <span class="n">up</span> <span class="o">=</span> <span class="n">BinaryRectangle</span><span class="p">(</span><span class="n">upSpec</span><span class="p">)</span>
      <span class="n">up</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">partition_node</span><span class="o">.</span><span class="n">bounds</span>
      
      <span class="k">return</span> <span class="n">down</span><span class="p">,</span> <span class="n">up</span><span class="p">,</span> <span class="n">downPoint</span><span class="p">,</span> <span class="n">upPoint</span>


<div class="viewcode-block" id="BayesSeparationAlgorithm"><a class="viewcode-back" href="../../../index.html#pyec.util.partitions.BayesSeparationAlgorithm">[docs]</a><span class="k">class</span> <span class="nc">BayesSeparationAlgorithm</span><span class="p">(</span><span class="n">VectorSeparationAlgorithm</span><span class="p">):</span>
   <span class="sd">&quot;&quot;&quot;Separation algorithm for Bayesian networks based on structure.&quot;&quot;&quot;</span>
   <span class="k">def</span> <span class="nf">compatible</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">space</span><span class="p">):</span>
      <span class="kn">from</span> <span class="nn">pyec.distribution.bayes.net</span> <span class="kn">import</span> <span class="n">BayesNet</span>
      <span class="k">return</span> <span class="n">space</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">BayesNet</span>
   
   <span class="k">def</span> <span class="nf">rectify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pointrep</span><span class="p">,</span> <span class="n">otherrep</span><span class="p">):</span>
      <span class="k">return</span> <span class="n">pointrep</span><span class="p">,</span> <span class="n">otherrep</span>
   
   <span class="k">def</span> <span class="nf">chooseIndex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pointrep</span><span class="p">,</span> <span class="n">otherrep</span><span class="p">,</span> <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">):</span>
      <span class="n">pointrep</span><span class="o">.</span><span class="n">computeEdgeStatistics</span><span class="p">()</span>
      <span class="n">otherrep</span><span class="o">.</span><span class="n">computeEdgeStatistics</span><span class="p">()</span>
      <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">pointrep</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
         <span class="k">if</span> <span class="n">edge</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">otherrep</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">edge</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lower</span> <span class="ow">and</span> <span class="n">edge</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">upper</span><span class="p">:</span>
               <span class="k">return</span> <span class="n">edge</span><span class="p">,</span> <span class="mf">1.0</span>
         
      <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">otherrep</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
         <span class="k">if</span> <span class="n">edge</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pointrep</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">edge</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lower</span> <span class="ow">and</span> <span class="n">edge</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">upper</span><span class="p">:</span>
               <span class="k">return</span> <span class="n">edge</span><span class="p">,</span> <span class="mf">1.0</span>
      
      <span class="k">raise</span> <span class="n">SeparationException</span><span class="p">(</span><span class="s">&quot;No difference in points&quot;</span><span class="p">)</span>

   <span class="k">def</span> <span class="nf">makeParts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">pointrep</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">otherrep</span><span class="p">,</span> <span class="n">newIndex</span><span class="p">,</span> <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">):</span>
      <span class="kn">from</span> <span class="nn">pyec.distribution.bayes.space</span> <span class="kn">import</span> <span class="n">BayesNetFixedEdges</span>
      <span class="n">pointrep</span><span class="o">.</span><span class="n">computeEdgeStatistics</span><span class="p">()</span>
      <span class="n">otherrep</span><span class="o">.</span><span class="n">computeEdgeStatistics</span><span class="p">()</span>
      
      <span class="k">if</span> <span class="n">newIndex</span> <span class="ow">in</span> <span class="n">pointrep</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
         <span class="n">upPoint</span> <span class="o">=</span> <span class="n">point</span>
         <span class="n">downPoint</span> <span class="o">=</span> <span class="n">other</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="n">upPoint</span> <span class="o">=</span> <span class="n">other</span>
         <span class="n">downPoint</span> <span class="o">=</span> <span class="n">point</span>
      
      <span class="n">downEdges</span> <span class="o">=</span> <span class="n">scopy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">upper</span><span class="p">)</span>
      <span class="n">downNedges</span> <span class="o">=</span> <span class="n">scopy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">lower</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="n">newIndex</span><span class="p">]</span>
      <span class="n">down</span> <span class="o">=</span> <span class="n">BayesNetFixedEdges</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">space</span><span class="o">.</span><span class="n">space</span><span class="p">,</span> <span class="n">downEdges</span><span class="p">,</span> <span class="n">downNedges</span><span class="p">)</span>
      <span class="n">down</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">partition_node</span><span class="o">.</span><span class="n">bounds</span>
      
      <span class="n">upEdges</span> <span class="o">=</span> <span class="n">scopy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">upper</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="n">newIndex</span><span class="p">]</span>
      <span class="n">upNedges</span> <span class="o">=</span> <span class="n">scopy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">lower</span><span class="p">)</span>
      <span class="n">up</span> <span class="o">=</span> <span class="n">BayesNetFixedEdges</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">space</span><span class="o">.</span><span class="n">space</span><span class="p">,</span> <span class="n">upEdges</span><span class="p">,</span> <span class="n">upNedges</span><span class="p">)</span>
      <span class="n">up</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">partition_node</span><span class="o">.</span><span class="n">bounds</span>
      
      <span class="k">return</span> <span class="n">down</span><span class="p">,</span> <span class="n">up</span><span class="p">,</span> <span class="n">downPoint</span><span class="p">,</span> <span class="n">upPoint</span>

</div>
<div class="viewcode-block" id="LayeredSeparationAlgorithm"><a class="viewcode-back" href="../../../index.html#pyec.util.partitions.LayeredSeparationAlgorithm">[docs]</a><span class="k">class</span> <span class="nc">LayeredSeparationAlgorithm</span><span class="p">(</span><span class="n">SeparationAlgorithm</span><span class="p">):</span>
   <span class="sd">&quot;&quot;&quot;Used to separate spaces defined by a layer hierarchy; written</span>
<span class="sd">   for neural networks initially. Assumes that the space is divided</span>
<span class="sd">   into layered strata; see :class:`LayeredSpace`. The bottom layer</span>
<span class="sd">   is separated differently from the higher layers, and so the config</span>
<span class="sd">   should contain a property named &quot;secondary_separator&quot;</span>
<span class="sd">   that can be used to separate points in the lowest rung of the</span>
<span class="sd">   hierarchy.</span>
<span class="sd">   </span>
<span class="sd">   &quot;&quot;&quot;</span>
   <span class="k">def</span> <span class="nf">compatible</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">space</span><span class="p">):</span>
      <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">space</span><span class="p">,</span> <span class="n">LayeredSpace</span><span class="p">)</span>
   
   <span class="k">def</span> <span class="nf">firstPoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">point</span><span class="p">):</span>
      <span class="n">layers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">space</span><span class="o">.</span><span class="n">extractLayers</span><span class="p">(</span><span class="n">point</span><span class="o">.</span><span class="n">point</span><span class="p">)</span>
      <span class="n">other</span> <span class="o">=</span> <span class="bp">None</span>
      <span class="n">segment</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">segment</span>
      <span class="n">parent</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">parent</span>
      <span class="n">area</span> <span class="o">=</span> <span class="mf">1.0</span>
      <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">layers</span><span class="p">:</span>
         <span class="n">area</span> <span class="o">*=</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="s">&#39;layerFactor&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">layer</span><span class="o">.</span><span class="n">layerFactor</span><span class="p">()</span> <span class="ow">or</span> <span class="mf">1.0</span>
         <span class="n">node</span><span class="o">.</span><span class="n">bounds</span> <span class="o">=</span> <span class="n">layer</span>
         <span class="n">node</span><span class="o">.</span><span class="n">best_score</span> <span class="o">=</span> <span class="n">point</span><span class="o">.</span><span class="n">score</span>
         <span class="n">node</span><span class="o">.</span><span class="n">score_sum</span> <span class="o">=</span> <span class="n">point</span><span class="o">.</span><span class="n">score</span>
         <span class="k">if</span> <span class="n">other</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">other</span><span class="o">.</span><span class="n">bounds</span> <span class="o">=</span> <span class="n">Complement</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">bounds</span><span class="p">,</span> <span class="n">layer</span><span class="p">)</span>
         <span class="k">if</span> <span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">parent</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span><span class="p">,</span> <span class="n">other</span><span class="p">]</span>
         <span class="nb">next</span> <span class="o">=</span> <span class="n">PartitionTreeNode</span><span class="p">(</span><span class="n">segment</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
         <span class="n">other</span> <span class="o">=</span> <span class="n">PartitionTreeNode</span><span class="p">(</span><span class="n">segment</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
         <span class="n">parent</span> <span class="o">=</span> <span class="n">node</span>
         <span class="n">node</span> <span class="o">=</span> <span class="nb">next</span>
      <span class="n">node</span> <span class="o">=</span> <span class="nb">next</span><span class="o">.</span><span class="n">parent</span>
      <span class="n">node</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">bounds</span>
      <span class="n">node</span><span class="o">.</span><span class="n">point</span> <span class="o">=</span> <span class="n">point</span>
      <span class="n">node</span><span class="o">.</span><span class="n">area</span> <span class="o">=</span> <span class="n">area</span>
      <span class="n">point</span><span class="o">.</span><span class="n">partition_node</span> <span class="o">=</span> <span class="n">node</span>
      <span class="n">tree</span><span class="o">.</span><span class="n">areaTree</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
      <span class="k">while</span> <span class="n">node</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
         <span class="n">node</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">parent</span>
         <span class="n">node</span><span class="o">.</span><span class="n">area</span> <span class="o">=</span> <span class="n">area</span>
   
   <span class="k">def</span> <span class="nf">split</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
      <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">point</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">bounds</span><span class="p">,</span> <span class="n">Complement</span><span class="p">):</span>
         <span class="c"># we hit a complement node</span>
         <span class="n">layers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">space</span><span class="o">.</span><span class="n">extractLayers</span><span class="p">(</span><span class="n">point</span><span class="o">.</span><span class="n">point</span><span class="p">)</span>
         <span class="n">area</span> <span class="o">=</span> <span class="mf">1.0</span>
         <span class="k">while</span> <span class="n">node</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">subtrahend</span><span class="o">.</span><span class="n">__class__</span> <span class="o">!=</span> <span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">__class__</span><span class="p">:</span>
            <span class="n">layer</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">area</span> <span class="o">*=</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="s">&#39;layerFactor&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">layer</span><span class="o">.</span><span class="n">layerFactor</span><span class="p">()</span> <span class="ow">or</span> <span class="mf">1.0</span>
         <span class="n">segment</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">segment</span>
         <span class="n">parent</span> <span class="o">=</span> <span class="n">node</span>
         <span class="n">node</span> <span class="o">=</span> <span class="n">PartitionTreeNode</span><span class="p">(</span><span class="n">segment</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
         <span class="n">other</span> <span class="o">=</span> <span class="n">PartitionTreeNode</span><span class="p">(</span><span class="n">segment</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
         <span class="n">node</span><span class="o">.</span><span class="n">best_score</span> <span class="o">=</span> <span class="n">point</span><span class="o">.</span><span class="n">score</span>
         <span class="n">node</span><span class="o">.</span><span class="n">score_sum</span> <span class="o">=</span> <span class="n">point</span><span class="o">.</span><span class="n">score</span>
         <span class="n">area</span> <span class="o">=</span> <span class="mf">1.0</span>
         <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">layers</span><span class="p">:</span>
            <span class="n">area</span> <span class="o">*=</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="s">&#39;layerFactor&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">layer</span><span class="o">.</span><span class="n">layerFactor</span><span class="p">()</span> <span class="ow">or</span> <span class="mf">1.0</span>
            <span class="n">node</span><span class="o">.</span><span class="n">bounds</span> <span class="o">=</span> <span class="n">layer</span>
            <span class="n">node</span><span class="o">.</span><span class="n">best_score</span> <span class="o">=</span> <span class="n">point</span><span class="o">.</span><span class="n">score</span>
            <span class="n">node</span><span class="o">.</span><span class="n">score_sum</span> <span class="o">=</span> <span class="n">point</span><span class="o">.</span><span class="n">score</span>
            <span class="n">other</span><span class="o">.</span><span class="n">bounds</span> <span class="o">=</span> <span class="n">Complement</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">bounds</span><span class="p">,</span> <span class="n">layer</span><span class="p">)</span>
            <span class="n">parent</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span><span class="p">,</span> <span class="n">other</span><span class="p">]</span>
            <span class="nb">next</span> <span class="o">=</span> <span class="n">PartitionTreeNode</span><span class="p">(</span><span class="n">segment</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="n">other</span> <span class="o">=</span> <span class="n">PartitionTreeNode</span><span class="p">(</span><span class="n">segment</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="n">parent</span> <span class="o">=</span> <span class="n">node</span>
            <span class="n">node</span> <span class="o">=</span> <span class="nb">next</span>
         <span class="n">node</span> <span class="o">=</span> <span class="n">parent</span>
         <span class="n">node</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">bounds</span>
         <span class="n">node</span><span class="o">.</span><span class="n">point</span> <span class="o">=</span> <span class="n">point</span>
         <span class="n">node</span><span class="o">.</span><span class="n">area</span> <span class="o">=</span> <span class="n">area</span>
         <span class="n">point</span><span class="o">.</span><span class="n">partition_node</span> <span class="o">=</span> <span class="n">node</span>
         <span class="n">current</span> <span class="o">=</span> <span class="n">node</span>
         <span class="k">while</span> <span class="n">current</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">current</span> <span class="o">=</span> <span class="n">current</span><span class="o">.</span><span class="n">parent</span>
            <span class="n">current</span><span class="o">.</span><span class="n">area</span> <span class="o">+=</span> <span class="n">area</span>
         <span class="k">return</span> <span class="n">node</span><span class="p">,</span> <span class="n">other</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="n">cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">Config</span><span class="p">(</span><span class="n">space</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">owner</span><span class="p">))</span>
         <span class="n">sep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">secondary_separator</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
         <span class="c"># problem: point.point is LayeredRnnGenotype;</span>
         <span class="c"># VectorSeparationAlgorithm expects np.ndarray for Euclidean</span>
         <span class="c"># need to remap point, here and in traverse</span>
         <span class="c"># or create a space wrapper</span>
         <span class="n">pt</span> <span class="o">=</span> <span class="n">point</span><span class="o">.</span><span class="n">point</span>
         <span class="n">other</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">point</span>
         <span class="n">otherPt</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">point</span>
         <span class="n">point</span><span class="o">.</span><span class="n">point</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">space</span><span class="o">.</span><span class="n">layers</span><span class="p">(</span><span class="n">pt</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
         <span class="n">other</span><span class="o">.</span><span class="n">point</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">space</span><span class="o">.</span><span class="n">layers</span><span class="p">(</span><span class="n">otherPt</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
         <span class="n">bounds</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">bounds</span>
         <span class="n">node</span><span class="o">.</span><span class="n">bounds</span> <span class="o">=</span> <span class="n">bounds</span><span class="o">.</span><span class="n">wrapped</span>
         <span class="k">try</span><span class="p">:</span>
            <span class="n">n1</span><span class="p">,</span><span class="n">n2</span> <span class="o">=</span> <span class="n">sep</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
            <span class="n">n1</span><span class="o">.</span><span class="n">bounds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">space</span><span class="o">.</span><span class="n">wrapLayer</span><span class="p">(</span><span class="n">n1</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>
            <span class="n">n2</span><span class="o">.</span><span class="n">bounds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">space</span><span class="o">.</span><span class="n">wrapLayer</span><span class="p">(</span><span class="n">n2</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>
         <span class="k">except</span><span class="p">:</span>
            <span class="n">node</span><span class="o">.</span><span class="n">point</span> <span class="o">=</span> <span class="n">other</span>
            <span class="k">raise</span>
         <span class="k">finally</span><span class="p">:</span>
            <span class="n">node</span><span class="o">.</span><span class="n">bounds</span> <span class="o">=</span> <span class="n">bounds</span>
            <span class="n">point</span><span class="o">.</span><span class="n">point</span> <span class="o">=</span> <span class="n">pt</span>
            <span class="n">other</span><span class="o">.</span><span class="n">point</span> <span class="o">=</span> <span class="n">otherPt</span>
         <span class="k">return</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span>

</div>
<span class="k">class</span> <span class="nc">PartitionTreeNode</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
   <span class="n">idgen</span> <span class="o">=</span> <span class="mi">1</span>
   
   <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">segment</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">upper</span><span class="p">,</span> <span class="n">lower</span><span class="p">,</span> <span class="n">area</span><span class="p">,</span>
                <span class="n">bounds</span><span class="p">,</span> <span class="n">point</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">layerrep</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                <span class="n">score_sum</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">best_score</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">segment</span> <span class="o">=</span> <span class="n">segment</span><span class="p">,</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">upper</span> <span class="o">=</span> <span class="n">upper</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">lower</span> <span class="o">=</span> <span class="n">lower</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">area</span> <span class="o">=</span> <span class="n">area</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">layer</span> <span class="o">=</span> <span class="n">layer</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">layerrep</span> <span class="o">=</span> <span class="n">layerrep</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">score_sum</span> <span class="o">=</span> <span class="n">score_sum</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">best_score</span> <span class="o">=</span> <span class="n">best_score</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">point</span> <span class="o">=</span> <span class="n">point</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">traversals</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span> <span class="o">=</span> <span class="n">bounds</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">idgen</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">idgen</span> <span class="o">+=</span> <span class="mi">1</span>


<span class="k">class</span> <span class="nc">Partition</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
   <span class="n">areaTree</span> <span class="o">=</span> <span class="bp">None</span>
   
   <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">segment</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">segment</span> <span class="o">=</span> <span class="n">segment</span>
               
      <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">PartitionTreeNode</span><span class="p">(</span>
         <span class="n">segment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">segment</span><span class="p">,</span>
         <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
         <span class="n">parent</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
         <span class="n">upper</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
         <span class="n">lower</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
         <span class="n">area</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">space</span><span class="o">.</span><span class="n">area</span><span class="p">(),</span>
         <span class="n">bounds</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">space</span><span class="p">,</span>
         <span class="n">point</span> <span class="o">=</span> <span class="bp">None</span>
      <span class="p">)</span>
      
      <span class="bp">self</span><span class="o">.</span><span class="n">areaTree</span> <span class="o">=</span> <span class="n">AreaTree</span><span class="p">()</span>
      
   <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="k">pass</span>

   <span class="k">def</span> <span class="nf">traverse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">point</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">         Traverse the partition tree to find the partition within which &quot;point&quot; is located.</span>
<span class="sd">         </span>
<span class="sd">         :param tree: The partition tree</span>
<span class="sd">         :type tree: :class:`Partition`</span>
<span class="sd">         :param point: The point for searching.</span>
<span class="sd">         :type point: ``config.space.type``</span>
<span class="sd">         :returns: A tuple with (partitionNode, path); with the</span>
<span class="sd">                   :class:`PartitionTreeNode` for the matching partition, and</span>
<span class="sd">                   the list of tree nodes traversed</span>

<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="n">Point</span><span class="p">):</span>
         <span class="n">point</span> <span class="o">=</span> <span class="n">point</span><span class="o">.</span><span class="n">point</span>
      
      <span class="c"># get the top parent</span>
      <span class="n">current</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span>
      <span class="n">region</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">bounds</span>
      <span class="n">path</span> <span class="o">=</span> <span class="p">[</span><span class="n">current</span><span class="p">]</span>
      
      <span class="n">last</span> <span class="o">=</span> <span class="bp">None</span>
      <span class="n">children</span> <span class="o">=</span> <span class="n">current</span><span class="o">.</span><span class="n">children</span>
      <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">children</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
         <span class="k">if</span> <span class="n">current</span> <span class="o">==</span> <span class="n">last</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;partition.traverse looped, exception&quot;</span>
            <span class="k">print</span> <span class="n">current</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">extent</span><span class="p">()</span>
            <span class="k">print</span> <span class="n">point</span><span class="o">.</span><span class="n">point</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;Loop in partition.traverse!&quot;</span><span class="p">)</span>
         <span class="n">last</span> <span class="o">=</span> <span class="n">current</span>
         
         <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">children</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">in_bounds</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">child</span><span class="o">.</span><span class="n">index</span><span class="p">):</span>
               <span class="n">current</span> <span class="o">=</span> <span class="n">child</span>
               <span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current</span><span class="p">)</span>
               <span class="n">children</span> <span class="o">=</span> <span class="n">current</span><span class="o">.</span><span class="n">children</span>
               <span class="k">break</span>
            
      <span class="n">node</span> <span class="o">=</span> <span class="n">current</span>
      <span class="k">return</span> <span class="n">node</span><span class="p">,</span> <span class="n">path</span>

   <span class="k">def</span> <span class="nf">propagateScoreSum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">         Propagate the score up the tree</span>
<span class="sd">         </span>
<span class="sd">         node - the node to start at (bottom-up traversal)</span>
<span class="sd">         config - an evo.config.Config</span>
<span class="sd">         </span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">current</span> <span class="o">=</span> <span class="n">node</span>
      <span class="k">while</span> <span class="n">current</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
         <span class="n">current</span><span class="o">.</span><span class="n">score_sum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">child</span><span class="o">.</span><span class="n">score_sum</span> <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">current</span><span class="o">.</span><span class="n">children</span><span class="p">])</span>
         <span class="n">current</span> <span class="o">=</span> <span class="n">current</span><span class="o">.</span><span class="n">parent</span>
      
   <span class="k">def</span> <span class="nf">computeDepth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">point</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">         compute the depth of the leaf that points to the db_point with id pointId</span>
<span class="sd">         </span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">depth</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="n">current</span> <span class="o">=</span> <span class="n">point</span><span class="o">.</span><span class="n">partition_node</span>
      <span class="k">while</span> <span class="n">current</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
         <span class="n">current</span> <span class="o">=</span> <span class="n">current</span><span class="o">.</span><span class="n">parent</span>
         <span class="k">if</span> <span class="n">current</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">depth</span> <span class="o">+=</span> <span class="mi">1</span>
      
      <span class="k">return</span> <span class="n">depth</span>
      
   <span class="k">def</span> <span class="nf">printTree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">segment</span><span class="p">,</span> <span class="n">node</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">):</span>
      <span class="k">if</span> <span class="n">node</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
         <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span>
      <span class="k">print</span> <span class="n">indent</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;: &quot;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">layer</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">bounds</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">area</span>
      <span class="n">children</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">children</span>
      <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">children</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">printTree</span><span class="p">(</span><span class="n">segment</span><span class="p">,</span> <span class="n">child</span><span class="p">,</span> <span class="n">indent</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">)</span>      

   <span class="k">def</span> <span class="nf">largestArea</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="k">try</span><span class="p">:</span>
         <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">areaTree</span><span class="o">.</span><span class="n">largest</span><span class="p">()</span>
      <span class="k">except</span> <span class="n">AreaException</span><span class="p">:</span>
         <span class="k">return</span> <span class="mf">1.0</span>

      
<span class="k">class</span> <span class="nc">ScoreTreeNode</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
   <span class="n">idgen</span> <span class="o">=</span> <span class="mi">1</span>

   <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">segment</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">point</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">area</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">min_score</span><span class="o">=-</span><span class="mf">1e300</span><span class="p">,</span> <span class="n">max_score</span><span class="o">=</span><span class="mf">1e300</span><span class="p">,</span> <span class="n">child_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">taylor</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">balance</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">segment</span> <span class="o">=</span> <span class="n">segment</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">point</span> <span class="o">=</span> <span class="n">point</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">area</span> <span class="o">=</span> <span class="n">area</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">min_score</span><span class="o">=</span><span class="n">min_score</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">max_score</span><span class="o">=</span><span class="n">max_score</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">child_count</span><span class="o">=</span><span class="n">child_count</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">taylor</span><span class="o">=</span><span class="n">taylor</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="o">=</span><span class="n">height</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">balance</span><span class="o">=</span><span class="n">balance</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">left</span><span class="o">=</span><span class="n">left</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">idgen</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">idgen</span> <span class="o">+=</span> <span class="mi">1</span>
      
<span class="k">class</span> <span class="nc">ScoreTree</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
   
   <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">segment</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">segment</span> <span class="o">=</span> <span class="n">segment</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">ScoreTreeNode</span><span class="p">(</span>
         <span class="n">segment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">segment</span><span class="p">,</span>
         <span class="n">parent</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
         <span class="n">point</span> <span class="o">=</span> <span class="bp">None</span>
      <span class="p">)</span>
      
   <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="k">pass</span>

   <span class="k">def</span> <span class="nf">printTree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">segment</span><span class="p">,</span> <span class="n">node</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">         Recursively print the score tree.</span>
<span class="sd">         </span>
<span class="sd">         segment - the segment for the tree to print</span>
<span class="sd">         node - the node to start at, or None for the root</span>
<span class="sd">         indent - a prefix for printing; tabs added for each new level</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="n">node</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> 
         <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span>
      
      <span class="k">print</span> <span class="n">indent</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s">&#39;,&#39;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">balance</span><span class="p">,</span> <span class="s">&quot;,&quot;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">area</span><span class="p">,</span> <span class="s">&quot;,&quot;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
      <span class="k">print</span> <span class="s">&quot;,&quot;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">child_count</span><span class="p">,</span> <span class="s">&quot;,&quot;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">min_score</span><span class="p">,</span> <span class="s">&quot; - &quot;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">max_score</span>
      
      <span class="n">children</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">children</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">children</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
         <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">children</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">left</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">printTree</span><span class="p">(</span><span class="n">segment</span><span class="p">,</span> <span class="n">child</span><span class="p">,</span> <span class="n">indent</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">)</span>

   <span class="k">def</span> <span class="nf">checkBalance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
      <span class="k">if</span> <span class="n">node</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
         <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span>
      
      <span class="k">try</span><span class="p">:</span>
         <span class="n">children</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">children</span>
         <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">children</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">children</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">children</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">left</span><span class="p">)</span>
            <span class="k">assert</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">balance</span> <span class="o">==</span> <span class="p">(</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">height</span> <span class="o">-</span> <span class="n">children</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">height</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">children</span><span class="p">:</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">checkBalance</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
      <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
         <span class="k">print</span> <span class="s">&quot;NODE: &quot;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">balance</span><span class="p">,</span> <span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="n">children</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">height</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">printTree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">segment</span><span class="p">)</span>
         <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&quot;Boo&quot;</span><span class="p">)</span>
      <span class="k">except</span><span class="p">:</span>
         <span class="k">raise</span>

   <span class="k">def</span> <span class="nf">rotateLeft</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">         Perform a left rotation at a node in the tree. For balancing.</span>
<span class="sd">         </span>
<span class="sd">         node - the node to rotate left.</span>
<span class="sd">         config - a config object with property &quot;shiftToDb&quot;</span>
<span class="sd">         </span>
<span class="sd">         Returns -1, the change in tree height. This return will only be correct</span>
<span class="sd">         if used in the context of an AVL tree balancing algorithm - otherwise</span>
<span class="sd">         the height change would need to be computed differently (it is possible).</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">center</span> <span class="o">=</span> <span class="n">node</span>
      <span class="n">children</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">left</span><span class="p">)</span>
      <span class="n">left</span> <span class="o">=</span> <span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="n">right</span> <span class="o">=</span> <span class="n">children</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
      
      <span class="n">right</span><span class="o">.</span><span class="n">left</span> <span class="o">=</span> <span class="n">center</span><span class="o">.</span><span class="n">left</span>
      <span class="n">center</span><span class="o">.</span><span class="n">left</span> <span class="o">=</span> <span class="bp">True</span>
      <span class="n">left</span><span class="o">.</span><span class="n">left</span> <span class="o">=</span> <span class="bp">True</span>
      
      <span class="n">children</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">right</span><span class="o">.</span><span class="n">children</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">left</span><span class="p">)</span>
      <span class="n">rightleft</span> <span class="o">=</span> <span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="n">rightright</span> <span class="o">=</span> <span class="n">children</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>   
      
      <span class="n">rightleft</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">center</span>
      <span class="n">rightleft</span><span class="o">.</span><span class="n">left</span> <span class="o">=</span> <span class="bp">False</span>
      <span class="n">right</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">center</span><span class="o">.</span><span class="n">parent</span>
      <span class="n">center</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">right</span>

      <span class="n">center</span><span class="o">.</span><span class="n">area</span> <span class="o">=</span> <span class="n">left</span><span class="o">.</span><span class="n">area</span> <span class="o">+</span> <span class="n">rightleft</span><span class="o">.</span><span class="n">area</span>
      <span class="n">right</span><span class="o">.</span><span class="n">area</span> <span class="o">=</span> <span class="n">center</span><span class="o">.</span><span class="n">area</span> <span class="o">+</span> <span class="n">rightright</span><span class="o">.</span><span class="n">area</span>
      
      <span class="n">center</span><span class="o">.</span><span class="n">taylor</span> <span class="o">=</span> <span class="n">left</span><span class="o">.</span><span class="n">taylor</span> <span class="o">+</span> <span class="n">rightleft</span><span class="o">.</span><span class="n">taylor</span>
      <span class="n">right</span><span class="o">.</span><span class="n">taylor</span> <span class="o">=</span> <span class="n">center</span><span class="o">.</span><span class="n">taylor</span> <span class="o">+</span> <span class="n">rightright</span><span class="o">.</span><span class="n">taylor</span>
      
      <span class="n">center</span><span class="o">.</span><span class="n">min_score</span> <span class="o">=</span> <span class="n">rightleft</span><span class="o">.</span><span class="n">min_score</span>
      <span class="n">center</span><span class="o">.</span><span class="n">max_score</span> <span class="o">=</span> <span class="n">left</span><span class="o">.</span><span class="n">max_score</span>
      <span class="n">right</span><span class="o">.</span><span class="n">min_score</span> <span class="o">=</span> <span class="n">rightright</span><span class="o">.</span><span class="n">min_score</span>
      <span class="n">right</span><span class="o">.</span><span class="n">max_score</span> <span class="o">=</span> <span class="n">center</span><span class="o">.</span><span class="n">max_score</span>
      
      
      <span class="n">center</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">left</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="n">rightleft</span><span class="o">.</span><span class="n">height</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span>
      <span class="n">right</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">center</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="n">rightright</span><span class="o">.</span><span class="n">height</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span>

      <span class="n">center</span><span class="o">.</span><span class="n">child_count</span> <span class="o">=</span> <span class="n">left</span><span class="o">.</span><span class="n">child_count</span> <span class="o">+</span> <span class="n">rightleft</span><span class="o">.</span><span class="n">child_count</span> <span class="o">+</span> <span class="mi">1</span>
      <span class="n">right</span><span class="o">.</span><span class="n">child_count</span> <span class="o">=</span> <span class="n">center</span><span class="o">.</span><span class="n">child_count</span> <span class="o">+</span> <span class="n">rightright</span><span class="o">.</span><span class="n">child_count</span> <span class="o">+</span> <span class="mi">1</span>

      <span class="n">center</span><span class="o">.</span><span class="n">balance</span> <span class="o">=</span> <span class="n">center</span><span class="o">.</span><span class="n">balance</span> <span class="o">+</span> <span class="mi">1</span>
      <span class="k">if</span> <span class="n">right</span><span class="o">.</span><span class="n">balance</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
         <span class="n">center</span><span class="o">.</span><span class="n">balance</span> <span class="o">=</span> <span class="n">center</span><span class="o">.</span><span class="n">balance</span> <span class="o">-</span> <span class="n">right</span><span class="o">.</span><span class="n">balance</span>
      
      <span class="n">right</span><span class="o">.</span><span class="n">balance</span> <span class="o">=</span> <span class="n">right</span><span class="o">.</span><span class="n">balance</span> <span class="o">+</span> <span class="mi">1</span>
      <span class="k">if</span> <span class="n">center</span><span class="o">.</span><span class="n">balance</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
         <span class="n">right</span><span class="o">.</span><span class="n">balance</span> <span class="o">=</span> <span class="n">right</span><span class="o">.</span><span class="n">balance</span> <span class="o">+</span> <span class="n">center</span><span class="o">.</span><span class="n">balance</span>
      
        
      <span class="n">center</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="p">[</span><span class="n">left</span><span class="p">,</span><span class="n">rightleft</span><span class="p">]</span>
      <span class="n">right</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="p">[</span><span class="n">center</span><span class="p">,</span><span class="n">rightright</span><span class="p">]</span>
      <span class="k">if</span> <span class="n">right</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
         <span class="n">right</span><span class="o">.</span><span class="n">segment</span><span class="o">.</span><span class="n">scoreTree</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">right</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="n">newChildren</span> <span class="o">=</span> <span class="p">[</span><span class="n">right</span><span class="p">]</span>
         <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">right</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">child</span> <span class="o">!=</span> <span class="n">center</span><span class="p">:</span>
               <span class="n">newChildren</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
         <span class="n">right</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="n">newChildren</span> 
         
      <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>

   <span class="k">def</span> <span class="nf">rotateRight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">         Perform a right rotation at a node in the tree. For balancing.</span>
<span class="sd">         </span>
<span class="sd">         node - the node to rotate right.</span>
<span class="sd">         config - a config object with property &quot;shiftToDb&quot;</span>
<span class="sd">         </span>
<span class="sd">         Returns -1, the change in tree height. This return will only be correct</span>
<span class="sd">         if used in the context of an AVL tree balancing algorithm - otherwise</span>
<span class="sd">         the height change would need to be computed differently (it is possible).</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">center</span> <span class="o">=</span> <span class="n">node</span>
      <span class="n">children</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">left</span><span class="p">)</span>
      
      <span class="n">left</span> <span class="o">=</span> <span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="n">right</span> <span class="o">=</span> <span class="n">children</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
      
      <span class="n">left</span><span class="o">.</span><span class="n">left</span> <span class="o">=</span> <span class="n">center</span><span class="o">.</span><span class="n">left</span>
      <span class="n">center</span><span class="o">.</span><span class="n">left</span> <span class="o">=</span> <span class="bp">False</span>
      <span class="n">right</span><span class="o">.</span><span class="n">left</span> <span class="o">=</span> <span class="bp">False</span>
      
      <span class="n">children</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">left</span><span class="o">.</span><span class="n">children</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">left</span><span class="p">)</span>
      <span class="n">leftleft</span> <span class="o">=</span> <span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="n">leftright</span> <span class="o">=</span> <span class="n">children</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

      <span class="n">leftright</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">center</span>
      <span class="n">leftright</span><span class="o">.</span><span class="n">left</span> <span class="o">=</span> <span class="bp">True</span>
      <span class="n">left</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">center</span><span class="o">.</span><span class="n">parent</span>
      <span class="n">center</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">left</span>

      <span class="n">center</span><span class="o">.</span><span class="n">area</span> <span class="o">=</span> <span class="n">right</span><span class="o">.</span><span class="n">area</span> <span class="o">+</span> <span class="n">leftright</span><span class="o">.</span><span class="n">area</span>
      <span class="n">left</span><span class="o">.</span><span class="n">area</span> <span class="o">=</span> <span class="n">center</span><span class="o">.</span><span class="n">area</span> <span class="o">+</span> <span class="n">leftleft</span><span class="o">.</span><span class="n">area</span>
      
      <span class="n">center</span><span class="o">.</span><span class="n">taylor</span> <span class="o">=</span> <span class="n">right</span><span class="o">.</span><span class="n">taylor</span> <span class="o">+</span> <span class="n">leftright</span><span class="o">.</span><span class="n">taylor</span>
      <span class="n">left</span><span class="o">.</span><span class="n">taylor</span> <span class="o">=</span> <span class="n">center</span><span class="o">.</span><span class="n">taylor</span> <span class="o">+</span> <span class="n">leftleft</span><span class="o">.</span><span class="n">taylor</span>
   
      <span class="n">center</span><span class="o">.</span><span class="n">min_score</span> <span class="o">=</span> <span class="n">right</span><span class="o">.</span><span class="n">min_score</span>
      <span class="n">center</span><span class="o">.</span><span class="n">max_score</span> <span class="o">=</span> <span class="n">leftright</span><span class="o">.</span><span class="n">max_score</span>
      <span class="n">left</span><span class="o">.</span><span class="n">min_score</span> <span class="o">=</span> <span class="n">center</span><span class="o">.</span><span class="n">min_score</span>
      <span class="n">left</span><span class="o">.</span><span class="n">max_score</span> <span class="o">=</span> <span class="n">leftleft</span><span class="o">.</span><span class="n">max_score</span>
      

      <span class="n">center</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">right</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="n">leftright</span><span class="o">.</span><span class="n">height</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span>
      <span class="n">left</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">center</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="n">leftleft</span><span class="o">.</span><span class="n">height</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span>

      <span class="n">center</span><span class="o">.</span><span class="n">child_count</span> <span class="o">=</span> <span class="n">leftright</span><span class="o">.</span><span class="n">child_count</span> <span class="o">+</span> <span class="n">right</span><span class="o">.</span><span class="n">child_count</span> <span class="o">+</span> <span class="mi">1</span>
      <span class="n">left</span><span class="o">.</span><span class="n">child_count</span> <span class="o">=</span> <span class="n">center</span><span class="o">.</span><span class="n">child_count</span> <span class="o">+</span> <span class="n">leftleft</span><span class="o">.</span><span class="n">child_count</span> <span class="o">+</span> <span class="mi">1</span>

      <span class="n">center</span><span class="o">.</span><span class="n">balance</span> <span class="o">=</span> <span class="n">center</span><span class="o">.</span><span class="n">balance</span> <span class="o">-</span> <span class="mi">1</span>
      <span class="k">if</span> <span class="n">left</span><span class="o">.</span><span class="n">balance</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
         <span class="n">center</span><span class="o">.</span><span class="n">balance</span> <span class="o">=</span> <span class="n">center</span><span class="o">.</span><span class="n">balance</span> <span class="o">-</span> <span class="n">left</span><span class="o">.</span><span class="n">balance</span>

      <span class="n">left</span><span class="o">.</span><span class="n">balance</span> <span class="o">=</span> <span class="n">left</span><span class="o">.</span><span class="n">balance</span> <span class="o">-</span> <span class="mi">1</span>
      <span class="k">if</span> <span class="n">center</span><span class="o">.</span><span class="n">balance</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
         <span class="n">left</span><span class="o">.</span><span class="n">balance</span> <span class="o">=</span> <span class="n">left</span><span class="o">.</span><span class="n">balance</span> <span class="o">+</span> <span class="n">center</span><span class="o">.</span><span class="n">balance</span>

      <span class="n">center</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="p">[</span><span class="n">leftright</span><span class="p">,</span><span class="n">right</span><span class="p">]</span>      
      <span class="n">left</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="p">[</span><span class="n">leftleft</span><span class="p">,</span><span class="n">center</span><span class="p">]</span>
      <span class="k">if</span> <span class="n">left</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
         <span class="n">left</span><span class="o">.</span><span class="n">segment</span><span class="o">.</span><span class="n">scoreTree</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">left</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="n">newChildren</span> <span class="o">=</span> <span class="p">[</span><span class="n">left</span><span class="p">]</span>
         <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">left</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">child</span> <span class="o">!=</span> <span class="n">center</span><span class="p">:</span>
               <span class="n">newChildren</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
         <span class="n">left</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="n">newChildren</span> 
      
      <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
      
      
   <span class="k">def</span> <span class="nf">traverse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">         Traverse the score tree.</span>
<span class="sd">         </span>
<span class="sd">         point - the point to compare</span>
<span class="sd">         config - an evo.config.Config instance with property &quot;shiftToDb&quot;</span>
<span class="sd">         </span>
<span class="sd">         Returns node in the tree that must be split to insert the new point into the tree.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">current</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span>
      <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
         <span class="n">children</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">current</span><span class="o">.</span><span class="n">children</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">left</span><span class="p">)</span>
         <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">children</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">break</span>
         <span class="k">if</span> <span class="n">children</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">max_score</span> <span class="o">&lt;</span> <span class="n">point</span><span class="o">.</span><span class="n">score</span><span class="p">:</span>
            <span class="n">current</span> <span class="o">=</span> <span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="n">current</span> <span class="o">=</span> <span class="n">children</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
      <span class="k">return</span> <span class="n">current</span>

   <span class="k">def</span> <span class="nf">removeLeaf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
      <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
         <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">point</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">node</span><span class="o">.</span><span class="n">point</span><span class="o">.</span><span class="n">score_node</span> <span class="o">=</span> <span class="bp">None</span>
         <span class="n">node</span><span class="o">.</span><span class="n">point</span> <span class="o">=</span> <span class="bp">None</span>
         <span class="k">return</span>
          
      <span class="n">parent</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">parent</span>
      <span class="n">other</span> <span class="o">=</span> <span class="p">[</span><span class="n">child</span> <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">children</span> <span class="k">if</span> <span class="n">child</span> <span class="o">!=</span> <span class="n">node</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
      
      <span class="n">left</span> <span class="o">=</span> <span class="bp">True</span>
      <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">child</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">children</span><span class="p">):</span>
         <span class="k">if</span> <span class="n">child</span> <span class="o">==</span> <span class="n">parent</span><span class="p">:</span>
            <span class="n">left</span> <span class="o">=</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> 
            <span class="k">break</span>
      
      <span class="n">parent</span><span class="o">.</span><span class="n">area</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">area</span>
      <span class="n">parent</span><span class="o">.</span><span class="n">point</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">point</span>
      <span class="n">parent</span><span class="o">.</span><span class="n">min_score</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">min_score</span>
      <span class="n">parent</span><span class="o">.</span><span class="n">max_score</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">max_score</span>
      <span class="n">parent</span><span class="o">.</span><span class="n">taylor</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">taylor</span>
      <span class="n">parent</span><span class="o">.</span><span class="n">balance</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="n">parent</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="k">del</span> <span class="n">node</span>
      <span class="k">del</span> <span class="n">other</span>
      <span class="n">parent</span><span class="o">.</span><span class="n">height</span> <span class="o">-=</span> <span class="mi">1</span>
      <span class="k">if</span> <span class="n">parent</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
         <span class="c">#print &quot;before, &quot;, parent.parent_id</span>
         <span class="c">#self.printTree(parent.segment)</span>
      
      
         <span class="n">superparent</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">parent</span>
         <span class="k">if</span> <span class="n">left</span><span class="p">:</span>
            <span class="n">superparent</span><span class="o">.</span><span class="n">balance</span> <span class="o">-=</span> <span class="mi">1</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="n">superparent</span><span class="o">.</span><span class="n">balance</span> <span class="o">+=</span> <span class="mi">1</span>
         <span class="k">if</span> <span class="n">superparent</span><span class="o">.</span><span class="n">balance</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">superparent</span><span class="o">.</span><span class="n">height</span> <span class="o">-=</span> <span class="mi">1</span>
         
         <span class="bp">self</span><span class="o">.</span><span class="n">propagateArea</span><span class="p">(</span><span class="n">superparent</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
         
         <span class="c">#print &quot;after, &quot;, superparent.id</span>
         <span class="c">#self.printTree(parent.segment)</span>
      

   <span class="k">def</span> <span class="nf">propagateAreaOnly</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">diff</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">         Propagate the change in area given by &quot;diff&quot; </span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">parent</span> <span class="o">=</span> <span class="n">node</span>
      <span class="k">while</span> <span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
         <span class="n">parent</span><span class="o">.</span><span class="n">area</span> <span class="o">-=</span> <span class="nb">float</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span>
         <span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">parent</span>
      

   <span class="k">def</span> <span class="nf">propagateArea</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">inserted</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">         Propagate the area and other features up the score tree, balancing as needed using an AVL algorithm.</span>
<span class="sd">         </span>
<span class="sd">         For balancing, positive numbers are heavy on the left, negative numbers are heavy on the right.</span>
<span class="sd">         </span>
<span class="sd">         node - the node to start at (bottom-up traversal)</span>
<span class="sd">         config - an evo.config.Config object with property &quot;shiftToDb&quot;</span>
<span class="sd">         inserted - how many new levels have been added to the tree, 1 or 0. If 0, no balancing is needed.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      
      <span class="k">if</span> <span class="n">inserted</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
         <span class="n">heightChange</span> <span class="o">=</span> <span class="n">inserted</span>
      <span class="k">elif</span> <span class="n">inserted</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
         <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">balance</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">heightChange</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="n">heightChange</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="n">heightChange</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="n">current</span> <span class="o">=</span> <span class="n">node</span>
      
      <span class="n">children</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">current</span><span class="o">.</span><span class="n">children</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">left</span><span class="p">)</span>
      <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
      
         <span class="n">left</span> <span class="o">=</span> <span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
         <span class="n">right</span> <span class="o">=</span> <span class="n">children</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
         
         <span class="k">if</span> <span class="n">left</span><span class="o">.</span><span class="n">min_score</span> <span class="o">&lt;</span> <span class="n">right</span><span class="o">.</span><span class="n">max_score</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">printTree</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">segment</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">,</span> <span class="s">&quot;Violated ordered assumption!&quot;</span>
            
         
         <span class="c"># is the current the right or the left child?</span>
         <span class="n">onLeft</span> <span class="o">=</span> <span class="n">current</span><span class="o">.</span><span class="n">left</span>
         
         
         <span class="n">rotated</span> <span class="o">=</span> <span class="bp">False</span>
         <span class="k">if</span> <span class="n">inserted</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">current</span><span class="o">.</span><span class="n">balance</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
               <span class="k">if</span> <span class="n">left</span><span class="o">.</span><span class="n">balance</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                  <span class="n">heightChange</span> <span class="o">-=</span> <span class="mi">1</span>
               <span class="k">if</span> <span class="n">left</span><span class="o">.</span><span class="n">balance</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                  <span class="n">rotated</span> <span class="o">=</span> <span class="bp">True</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">rotateRight</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
               <span class="k">else</span><span class="p">:</span><span class="c"># left.balance &lt; 0:</span>
                  <span class="n">rotated</span> <span class="o">=</span> <span class="bp">True</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">rotateLeft</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">rotateRight</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">current</span><span class="o">.</span><span class="n">balance</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
               <span class="k">if</span> <span class="n">right</span><span class="o">.</span><span class="n">balance</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                  <span class="n">heightChange</span> <span class="o">-=</span> <span class="mi">1</span>
               <span class="k">if</span> <span class="n">right</span><span class="o">.</span><span class="n">balance</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                  <span class="n">rotated</span> <span class="o">=</span> <span class="bp">True</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">rotateLeft</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
               <span class="k">else</span><span class="p">:</span><span class="c"># right.balance &gt; 0:</span>
                  <span class="n">rotated</span> <span class="o">=</span> <span class="bp">True</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">rotateRight</span><span class="p">(</span><span class="n">right</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">rotateLeft</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
               
         
         <span class="k">if</span> <span class="ow">not</span> <span class="n">rotated</span><span class="p">:</span>
            <span class="n">current</span><span class="o">.</span><span class="n">area</span> <span class="o">=</span> <span class="n">left</span><span class="o">.</span><span class="n">area</span> <span class="o">+</span> <span class="n">right</span><span class="o">.</span><span class="n">area</span>
            <span class="n">current</span><span class="o">.</span><span class="n">taylor</span> <span class="o">=</span> <span class="n">left</span><span class="o">.</span><span class="n">taylor</span> <span class="o">+</span> <span class="n">right</span><span class="o">.</span><span class="n">taylor</span>
            <span class="n">current</span><span class="o">.</span><span class="n">child_count</span> <span class="o">=</span> <span class="n">left</span><span class="o">.</span><span class="n">child_count</span> <span class="o">+</span> <span class="n">right</span><span class="o">.</span><span class="n">child_count</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">current</span><span class="o">.</span><span class="n">min_score</span> <span class="o">=</span> <span class="n">right</span><span class="o">.</span><span class="n">min_score</span>
            <span class="n">current</span><span class="o">.</span><span class="n">max_score</span> <span class="o">=</span> <span class="n">left</span><span class="o">.</span><span class="n">max_score</span>
         
         <span class="nb">next</span> <span class="o">=</span> <span class="bp">None</span>
         <span class="k">if</span> <span class="n">current</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="nb">next</span> <span class="o">=</span> <span class="n">current</span><span class="o">.</span><span class="n">parent</span>
            <span class="n">children</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">next</span><span class="o">.</span><span class="n">children</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">left</span><span class="p">)</span>
         
         <span class="k">if</span> <span class="n">inserted</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">next</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">oldbal</span> <span class="o">=</span> <span class="nb">next</span><span class="o">.</span><span class="n">balance</span>
            <span class="k">if</span> <span class="n">onLeft</span><span class="p">:</span>
               <span class="n">newbal</span> <span class="o">=</span> <span class="nb">next</span><span class="o">.</span><span class="n">balance</span> <span class="o">+</span> <span class="n">heightChange</span>
            <span class="k">else</span><span class="p">:</span>
               <span class="n">newbal</span> <span class="o">=</span> <span class="nb">next</span><span class="o">.</span><span class="n">balance</span> <span class="o">-</span> <span class="n">heightChange</span>
            <span class="nb">next</span><span class="o">.</span><span class="n">balance</span> <span class="o">=</span> <span class="n">newbal</span>
            <span class="k">if</span> <span class="n">inserted</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
               <span class="k">if</span> <span class="n">newbal</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                  <span class="n">heightChange</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
               <span class="k">if</span> <span class="n">newbal</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                  <span class="n">heightChange</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="nb">next</span><span class="o">.</span><span class="n">height</span> <span class="o">+=</span> <span class="n">heightChange</span>
         
         <span class="k">if</span> <span class="nb">next</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">break</span>
         <span class="n">current</span> <span class="o">=</span> <span class="nb">next</span>
         
      <span class="c">#if inserted != 0:</span>
      <span class="c">#   print &quot;after, &quot;, node.id, inserted</span>
      <span class="c">#   self.printTree(node.segment)</span>
      
      
   <span class="k">def</span> <span class="nf">insert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">stats</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">         Insert a new point into the score tree, then propagate area, taylor scores, and rebalance.</span>
<span class="sd">         Assumes the point has already been inserted into the partition tree</span>
<span class="sd">         </span>
<span class="sd">         point - the point to insert</span>
<span class="sd">         config - an evo.config.Config object with properties &quot;shiftToDb&quot;, &quot;taylorDepth&quot;, &quot;taylorCenter&quot;, &quot;selection&quot;</span>
<span class="sd">         stats - an evo.trainer.RunStats object</span>
<span class="sd">      &quot;&quot;&quot;</span>
      
      <span class="n">stats</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="s">&quot;insert.traverse&quot;</span><span class="p">)</span>
      <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
      <span class="n">stats</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="s">&quot;insert.traverse&quot;</span><span class="p">)</span>
      <span class="n">stats</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="s">&quot;insert.main&quot;</span><span class="p">)</span>
      <span class="n">lr</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">learningRate</span>
      
      <span class="n">ns</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mf">0.</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">segment</span><span class="o">.</span><span class="n">taylorDepth</span><span class="p">)]</span>
      <span class="n">fs</span> <span class="o">=</span> <span class="n">ns</span> <span class="o">*</span> <span class="mi">1</span>
      <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">taylorDepth</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
         <span class="n">fs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
         <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">segment</span><span class="o">.</span><span class="n">taylorDepth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">fs</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">*=</span> <span class="n">fs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
      <span class="n">ns</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="n">ns</span><span class="p">)</span>
      <span class="n">fs</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="n">fs</span><span class="p">)</span>
      <span class="n">center</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">segment</span><span class="o">.</span><span class="n">taylorCenter</span>      
      
      <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">point</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
         <span class="n">node</span><span class="o">.</span><span class="n">point</span> <span class="o">=</span> <span class="n">point</span>
         <span class="n">node</span><span class="o">.</span><span class="n">area</span> <span class="o">=</span> <span class="n">point</span><span class="o">.</span><span class="n">partition_node</span><span class="o">.</span><span class="n">area</span>
         <span class="n">node</span><span class="o">.</span><span class="n">min_score</span> <span class="o">=</span> <span class="n">point</span><span class="o">.</span><span class="n">score</span>
         <span class="n">node</span><span class="o">.</span><span class="n">max_score</span> <span class="o">=</span> <span class="n">point</span><span class="o">.</span><span class="n">score</span>
         <span class="n">score</span> <span class="o">=</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">minimize</span> <span class="ow">and</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">point</span><span class="o">.</span><span class="n">score</span> <span class="o">*</span> <span class="n">lr</span> 
         <span class="n">taylor</span> <span class="o">=</span> <span class="n">nan_to_num</span><span class="p">(</span><span class="n">score</span> <span class="o">**</span> <span class="n">ns</span><span class="p">)</span> <span class="o">/</span> <span class="n">fs</span>
         <span class="n">taylor</span> <span class="o">*=</span> <span class="n">node</span><span class="o">.</span><span class="n">area</span>
         <span class="n">taylor</span> <span class="o">*=</span> <span class="n">nan_to_num</span><span class="p">(</span><span class="n">exp</span><span class="p">(</span><span class="n">score</span><span class="o">/</span><span class="n">center</span><span class="p">))</span> 
         <span class="n">node</span><span class="o">.</span><span class="n">taylor</span> <span class="o">=</span> <span class="n">nan_to_num</span><span class="p">(</span><span class="n">taylor</span><span class="p">)</span>
         <span class="k">return</span>
      
      
      <span class="n">other</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">point</span>
      <span class="n">node</span><span class="o">.</span><span class="n">point</span> <span class="o">=</span> <span class="bp">None</span>
      
      <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">score</span> <span class="o">&gt;</span> <span class="n">point</span><span class="o">.</span><span class="n">score</span><span class="p">:</span>
         <span class="n">upPoint</span> <span class="o">=</span> <span class="n">other</span>
         <span class="n">downPoint</span> <span class="o">=</span> <span class="n">point</span>
         <span class="n">node</span><span class="o">.</span><span class="n">max_score</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">score</span>
         <span class="n">node</span><span class="o">.</span><span class="n">min_score</span> <span class="o">=</span> <span class="n">point</span><span class="o">.</span><span class="n">score</span>
      <span class="k">else</span><span class="p">:</span>
         <span class="n">upPoint</span> <span class="o">=</span> <span class="n">point</span>
         <span class="n">downPoint</span> <span class="o">=</span> <span class="n">other</span>
         <span class="n">node</span><span class="o">.</span><span class="n">max_score</span> <span class="o">=</span> <span class="n">point</span><span class="o">.</span><span class="n">score</span>
         <span class="n">node</span><span class="o">.</span><span class="n">min_score</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">score</span>
      
      <span class="n">node</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="mi">1</span>
      
      <span class="n">upArea</span> <span class="o">=</span> <span class="n">upPoint</span><span class="o">.</span><span class="n">partition_node</span><span class="o">.</span><span class="n">area</span>
      <span class="n">downArea</span> <span class="o">=</span> <span class="n">downPoint</span><span class="o">.</span><span class="n">partition_node</span><span class="o">.</span><span class="n">area</span>
      
      <span class="n">score1</span> <span class="o">=</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">minimize</span> <span class="ow">and</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">upPoint</span><span class="o">.</span><span class="n">score</span> <span class="o">*</span> <span class="n">lr</span>    
      <span class="n">score2</span> <span class="o">=</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">minimize</span> <span class="ow">and</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">downPoint</span><span class="o">.</span><span class="n">score</span> <span class="o">*</span> <span class="n">lr</span>    
      <span class="n">taylor1</span> <span class="o">=</span> <span class="p">(</span><span class="n">score1</span> <span class="o">**</span> <span class="n">ns</span><span class="p">)</span> <span class="o">/</span> <span class="n">fs</span>
      <span class="n">taylor1</span> <span class="o">*=</span> <span class="n">upArea</span>
      <span class="n">taylor1</span> <span class="o">*=</span> <span class="p">(</span><span class="n">exp</span><span class="p">(</span><span class="n">score1</span><span class="o">/</span><span class="n">center</span><span class="p">))</span> 
      <span class="n">taylor2</span> <span class="o">=</span> <span class="p">(</span><span class="n">score2</span> <span class="o">**</span> <span class="n">ns</span><span class="p">)</span> <span class="o">/</span> <span class="n">fs</span>
      <span class="n">taylor2</span> <span class="o">*=</span> <span class="n">downArea</span>
      <span class="n">taylor2</span> <span class="o">*=</span> <span class="p">(</span><span class="n">exp</span><span class="p">(</span><span class="n">score2</span><span class="o">/</span><span class="n">center</span><span class="p">))</span>
      
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">segment</span><span class="o">.</span><span class="n">taylorDepth</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
         <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">taylor1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-300</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">taylor2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-300</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="n">node</span><span class="o">.</span><span class="n">point</span> <span class="o">=</span> <span class="n">other</span>
            <span class="n">node</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">node</span><span class="o">.</span><span class="n">max_score</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">score</span>
            <span class="n">node</span><span class="o">.</span><span class="n">min_score</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">score</span>
            <span class="c"># node has not been saved to the DB, so we don&#39;t need to rollback</span>
            <span class="c">#node.save()</span>
            <span class="c">#transaction.rollback()</span>
            <span class="k">raise</span> <span class="n">SeparationException</span><span class="p">,</span> <span class="s">&quot;Zero taylor coeffs&quot;</span>
      
      <span class="n">n1</span> <span class="o">=</span> <span class="n">ScoreTreeNode</span><span class="p">(</span>
         <span class="n">segment</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">segment</span><span class="p">,</span>
         <span class="n">point</span><span class="o">=</span><span class="n">upPoint</span><span class="p">,</span>
         <span class="n">area</span> <span class="o">=</span> <span class="n">upArea</span><span class="p">,</span>
         <span class="n">parent</span> <span class="o">=</span> <span class="n">node</span><span class="p">,</span>
         <span class="n">max_score</span> <span class="o">=</span> <span class="n">upPoint</span><span class="o">.</span><span class="n">score</span><span class="p">,</span>
         <span class="n">min_score</span> <span class="o">=</span> <span class="n">upPoint</span><span class="o">.</span><span class="n">score</span><span class="p">,</span>
         <span class="n">left</span> <span class="o">=</span> <span class="n">upPoint</span><span class="o">.</span><span class="n">score</span> <span class="o">&gt;=</span> <span class="n">downPoint</span><span class="o">.</span><span class="n">score</span><span class="p">,</span>
         <span class="n">taylor</span> <span class="o">=</span> <span class="n">taylor1</span>
      <span class="p">)</span>
      
      <span class="n">n2</span> <span class="o">=</span> <span class="n">ScoreTreeNode</span><span class="p">(</span>
         <span class="n">segment</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">segment</span><span class="p">,</span>
         <span class="n">point</span><span class="o">=</span><span class="n">downPoint</span><span class="p">,</span>
         <span class="n">area</span> <span class="o">=</span> <span class="n">downArea</span><span class="p">,</span>
         <span class="n">parent</span> <span class="o">=</span> <span class="n">node</span><span class="p">,</span>
         <span class="n">max_score</span> <span class="o">=</span> <span class="n">downPoint</span><span class="o">.</span><span class="n">score</span><span class="p">,</span>
         <span class="n">min_score</span> <span class="o">=</span> <span class="n">downPoint</span><span class="o">.</span><span class="n">score</span><span class="p">,</span>
         <span class="n">left</span> <span class="o">=</span> <span class="n">upPoint</span><span class="o">.</span><span class="n">score</span> <span class="o">&lt;</span> <span class="n">downPoint</span><span class="o">.</span><span class="n">score</span><span class="p">,</span>
         <span class="n">taylor</span> <span class="o">=</span> <span class="n">taylor2</span>
      <span class="p">)</span>
      <span class="n">node</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="p">[</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">]</span>
      <span class="n">upPoint</span><span class="o">.</span><span class="n">score_node</span> <span class="o">=</span> <span class="n">n1</span>
      <span class="n">downPoint</span><span class="o">.</span><span class="n">score_node</span> <span class="o">=</span> <span class="n">n2</span>
      
      <span class="n">stats</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="s">&quot;insert.main&quot;</span><span class="p">)</span>
      <span class="n">stats</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="s">&quot;insert.propagate&quot;</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">propagateArea</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
      <span class="n">stats</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="s">&quot;insert.propagate&quot;</span><span class="p">)</span>

   <span class="k">def</span> <span class="nf">resetTaylor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">segment</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">         Recompute the taylor coefficients on the Score tree.</span>
<span class="sd">         </span>
<span class="sd">         This should be done whenever 1/temp gets more than 0.5 away</span>
<span class="sd">         from the inverse of the taylor center for accuracy.</span>
<span class="sd">         </span>
<span class="sd">         Requires a loop through all points, but only needs to be done</span>
<span class="sd">         at a logarithmically often pace.</span>
<span class="sd">         </span>
<span class="sd">         segment - the segment to recompute</span>
<span class="sd">         temp - the new temperature center</span>
<span class="sd">         config - an evo.config.Config object with &quot;shiftToDb&quot;, &quot;taylorCenter&quot;, &quot;taylorDepth&quot;</span>
<span class="sd">         </span>
<span class="sd">         This method sets config.taylorCenter to temp when complete.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;resetTaylor: segment </span><span class="si">%s</span><span class="s">, new center </span><span class="si">%s</span><span class="s">, old center </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">segment</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">taylorCenter</span><span class="p">))</span>
      
      <span class="n">ns</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mf">0.</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">segment</span><span class="o">.</span><span class="n">taylorDepth</span><span class="p">)]</span>
      <span class="n">fs</span> <span class="o">=</span> <span class="n">ns</span> <span class="o">*</span> <span class="mi">1</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
         <span class="n">fs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
         <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">segment</span><span class="o">.</span><span class="n">taylorDepth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">fs</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">*=</span> <span class="n">fs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
      <span class="n">ns</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="n">ns</span><span class="p">)</span>
      <span class="n">fs</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="n">fs</span><span class="p">)</span>
      <span class="n">lr</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">learningRate</span>
      <span class="n">center</span> <span class="o">=</span> <span class="n">temp</span>
      
      <span class="nb">next</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">segment</span><span class="o">.</span><span class="n">points</span><span class="p">:</span>
         <span class="k">if</span> <span class="n">point</span><span class="o">.</span><span class="n">alive</span> <span class="ow">and</span> <span class="n">point</span><span class="o">.</span><span class="n">score_node</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="nb">next</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">point</span><span class="o">.</span><span class="n">score_node</span><span class="p">)</span>
      
      <span class="n">heights</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="nb">next</span><span class="p">}</span>
      <span class="n">height</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="n">mult</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">minimize</span> <span class="ow">and</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="mi">1</span>
      <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">heights</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
         <span class="n">nodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">heights</span><span class="p">[</span><span class="n">height</span><span class="p">])</span>
         <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">point</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
               <span class="n">score</span> <span class="o">=</span> <span class="n">mult</span> <span class="o">*</span> <span class="n">lr</span> <span class="o">*</span> <span class="n">node</span><span class="o">.</span><span class="n">point</span><span class="o">.</span><span class="n">score</span>
               <span class="n">taylor</span> <span class="o">=</span> <span class="n">nan_to_num</span><span class="p">(</span><span class="n">score</span> <span class="o">**</span> <span class="n">ns</span><span class="p">)</span> <span class="o">/</span> <span class="n">fs</span>
               <span class="n">taylor</span> <span class="o">*=</span> <span class="n">node</span><span class="o">.</span><span class="n">area</span>
               <span class="n">taylor</span> <span class="o">*=</span> <span class="n">nan_to_num</span><span class="p">(</span><span class="n">exp</span><span class="p">(</span><span class="n">score</span><span class="o">/</span><span class="n">center</span><span class="p">))</span> 
               <span class="n">node</span><span class="o">.</span><span class="n">taylor</span> <span class="o">=</span> <span class="n">nan_to_num</span><span class="p">(</span><span class="n">taylor</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
               <span class="n">node</span><span class="o">.</span><span class="n">taylor</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">segment</span><span class="o">.</span><span class="n">taylorDepth</span><span class="p">)</span>
               <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                  <span class="n">node</span><span class="o">.</span><span class="n">taylor</span> <span class="o">+=</span> <span class="n">child</span><span class="o">.</span><span class="n">taylor</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
               <span class="k">if</span> <span class="ow">not</span> <span class="n">heights</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">height</span><span class="p">):</span>
                  <span class="n">heights</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">height</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">parent</span><span class="p">]</span>
               <span class="k">else</span><span class="p">:</span>
                  <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">parent</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">heights</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">height</span><span class="p">]:</span>
                     <span class="n">heights</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">height</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>
         <span class="k">del</span> <span class="n">heights</span><span class="p">[</span><span class="n">height</span><span class="p">]</span>
         <span class="n">height</span> <span class="o">+=</span> <span class="mi">1</span>
       
      <span class="n">segment</span><span class="o">.</span><span class="n">taylorCenter</span> <span class="o">=</span> <span class="n">temp</span>


<span class="k">class</span> <span class="nc">AreaTreeNode</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">idgen</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">parent</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">children</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">val</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">low</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">high</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">left</span> <span class="o">=</span> <span class="bp">False</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">idgen</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">idgen</span> <span class="o">+=</span> <span class="mi">1</span>
        

<span class="k">class</span> <span class="nc">AreaTree</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
      
    <span class="n">root</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="nb">map</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">traverse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">area</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
           <span class="k">raise</span> <span class="n">AreaException</span><span class="p">(</span><span class="s">&quot;Cannot traverse empty tree&quot;</span><span class="p">)</span>
        <span class="c">#elif self.root.low &gt; area or self.root.high &lt; area: # if we want this check, it needs to get the high from the space</span>
        <span class="c">#   err = &quot;Area {0} out of bounds ({1},{2})&quot;</span>
        <span class="c">#   err = err.format(area, self.root.low, self.root.high)</span>
        <span class="c">#   raise AreaException(err)</span>
           
        <span class="nb">next</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="nb">next</span><span class="o">.</span><span class="n">children</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">area</span> <span class="o">&gt;=</span> <span class="nb">next</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">low</span><span class="p">:</span>
                <span class="nb">next</span> <span class="o">=</span> <span class="nb">next</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">next</span> <span class="o">=</span> <span class="nb">next</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="nb">next</span>
    
    <span class="k">def</span> <span class="nf">insert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">partitionNode</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">AreaTreeNode</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">partitionNode</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
            <span class="k">return</span>
            
        <span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">partitionNode</span><span class="o">.</span><span class="n">area</span><span class="p">)</span>
        
        <span class="n">mid</span> <span class="o">=</span> <span class="n">partitionNode</span><span class="o">.</span><span class="n">area</span>
        
        <span class="n">left</span> <span class="o">=</span> <span class="n">AreaTreeNode</span><span class="p">()</span>
        <span class="n">left</span><span class="o">.</span><span class="n">left</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">left</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
        <span class="n">left</span><span class="o">.</span><span class="n">high</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">high</span>
        <span class="n">left</span><span class="o">.</span><span class="n">low</span> <span class="o">=</span> <span class="n">mid</span>
        
        <span class="n">right</span> <span class="o">=</span> <span class="n">AreaTreeNode</span><span class="p">()</span>
        <span class="n">right</span><span class="o">.</span><span class="n">left</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">right</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
        <span class="n">right</span><span class="o">.</span><span class="n">high</span> <span class="o">=</span> <span class="n">mid</span>
        <span class="n">right</span><span class="o">.</span><span class="n">low</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">low</span>
        
        <span class="k">if</span> <span class="n">parent</span><span class="o">.</span><span class="n">val</span><span class="o">.</span><span class="n">area</span> <span class="o">&gt;=</span> <span class="n">partitionNode</span><span class="o">.</span><span class="n">area</span><span class="p">:</span>
            <span class="n">right</span><span class="o">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">partitionNode</span>
            <span class="n">left</span><span class="o">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">val</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">left</span><span class="o">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">partitionNode</span>
            <span class="n">right</span><span class="o">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">val</span>
        
        <span class="k">assert</span> <span class="n">left</span><span class="o">.</span><span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
        <span class="k">assert</span> <span class="n">right</span><span class="o">.</span><span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
        <span class="k">assert</span> <span class="n">left</span><span class="o">.</span><span class="n">low</span> <span class="o">&gt;=</span> <span class="n">right</span><span class="o">.</span><span class="n">high</span>
        <span class="k">assert</span> <span class="n">left</span><span class="o">.</span><span class="n">val</span><span class="o">.</span><span class="n">area</span> <span class="o">&gt;=</span> <span class="n">right</span><span class="o">.</span><span class="n">val</span><span class="o">.</span><span class="n">area</span>    
                    
        <span class="n">parent</span><span class="o">.</span><span class="n">val</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">parent</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="p">[</span><span class="n">left</span><span class="p">,</span><span class="n">right</span><span class="p">]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="n">left</span><span class="o">.</span><span class="n">val</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">left</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="n">right</span><span class="o">.</span><span class="n">val</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">right</span>
        
        <span class="c">#print &quot;AFTER INSERT: &quot;</span>
        <span class="c">#self.printTree()</span>
        
    <span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">partitionNode</span><span class="p">):</span>        
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">partitionNode</span><span class="o">.</span><span class="n">id</span><span class="p">):</span>
            <span class="n">err</span> <span class="o">=</span> <span class="s">&quot;Area tree has no node {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">partitionNode</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">AreaException</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
            
        <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="n">partitionNode</span><span class="o">.</span><span class="n">id</span><span class="p">]</span>
        <span class="c">#print &quot;Removing &quot;, target.id</span>
        <span class="k">if</span> <span class="n">target</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">AreaException</span><span class="p">(</span><span class="s">&quot;Cannot remove root&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">target</span><span class="o">.</span><span class="n">left</span><span class="p">:</span>
            <span class="n">other</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">other</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="c">#print &quot;Other: &quot;, other.id</span>
        <span class="c">#print &quot;Parent: &quot;, target.parent.id</span>
        
        <span class="c">#assert len(other.children) or other.val is not None</span>
        
        <span class="n">target</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">val</span>
        <span class="n">target</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">children</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="n">child</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">parent</span>
        <span class="n">other</span><span class="o">.</span><span class="n">val</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">target</span><span class="o">.</span><span class="n">val</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">target</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="n">target</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">val</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">parent</span>

        <span class="c">#assert len(target.parent.children) or target.parent.val is not None </span>
        
        <span class="k">del</span> <span class="n">other</span>
        <span class="k">del</span> <span class="n">target</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="n">partitionNode</span><span class="o">.</span><span class="n">id</span><span class="p">]</span>
              
        <span class="c">#print &quot;AFTER REMOVE: &quot;</span>
        <span class="c">#self.printTree()</span>
      
    <span class="k">def</span> <span class="nf">largest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">AreaException</span><span class="p">(</span><span class="s">&quot;Area tree has no root&quot;</span><span class="p">)</span>
        
        <span class="nb">next</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="nb">next</span><span class="o">.</span><span class="n">children</span><span class="p">):</span>
            <span class="c">#print &quot;id: &quot;, (next.low, next.high)</span>
            <span class="nb">next</span> <span class="o">=</span> <span class="nb">next</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="nb">next</span><span class="o">.</span><span class="n">val</span><span class="o">.</span><span class="n">area</span>
    
    <span class="k">def</span> <span class="nf">printTree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">node</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span>
        <span class="k">print</span> <span class="n">indent</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">low</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">high</span><span class="p">,</span>
        <span class="k">print</span> <span class="n">node</span><span class="o">.</span><span class="n">val</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="s">&quot;None&quot;</span> <span class="ow">or</span> <span class="n">node</span><span class="o">.</span><span class="n">val</span><span class="o">.</span><span class="n">area</span>
        <span class="n">children</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">children</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">children</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">printTree</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">indent</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">)</span> 
   
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">PyEC 0.3.0 documentation</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, Alan J Lockett.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2b1.
    </div>
  </body>
</html>